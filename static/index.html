<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <title>Fantasy Football GPT Coach</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      padding: 40px 16px;
      background: #f8f9fa;
    }
    .container {
      max-width: 800px;
      width: 100%;
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    h1 { font-size: 28px; font-weight: 600; color: #202124; margin-bottom: 16px; }
    label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-family: inherit;
      box-sizing: border-box;
    }
    button {
      font-size: 16px;
      padding: 10px 20px;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      background: #444;
      color: white;
      margin-top: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #222;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }
    .button-row button {
      background: #555;
    }
    .button-row button:hover {
      background: #333;
    }

    /* Roster Builder Styles */
    .roster-section {
      margin-top: 20px;
    }
    .position-group {
      margin-bottom: 20px;
      padding: 16px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
    }
    .position-header {
      font-weight: 600;
      font-size: 16px;
      color: #333;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .position-count {
      font-size: 14px;
      color: #666;
      font-weight: normal;
    }
    .player-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .player-row input {
      flex: 1;
      margin-top: 0;
      padding: 8px 12px;
      font-size: 14px;
    }
    .remove-player {
      background: #ff4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 0;
      min-width: 60px;
    }
    .add-player {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .add-player:disabled {
      background: #ccc;
    }

    h2 {
      margin-top: 32px;
      font-size: 22px;
      font-weight: 600;
      border-bottom: 1px solid #ccc;
      padding-bottom: 6px;
    }
    .output {
      background: #fff;
      border: 1px solid #ddd;
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      opacity: 1;
      transform: translateY(0);
      transition: all 0.4s ease;
      box-sizing: border-box;
    }
    .bubble {
      position: relative;
      padding: 12px 16px;
      border-radius: 20px;
      margin: 12px 0;
      max-width: 90%;
      line-height: 1.4;
    }
    .bubble-advice {
      background: #f1f0f0;
      border: 1px solid #ccc;
      border-bottom-left-radius: 4px;
    }
    .bubble-advice::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 20px;
      border: 10px solid transparent;
      border-top-color: #f1f0f0;
      border-bottom: 0;
      margin-bottom: -10px;
    }
    .bubble-coach {
      background: #ddf;
      border: 1px solid #aad;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .bubble-coach::after {
      content: "";
      position: absolute;
      bottom: 0;
      right: 20px;
      border: 10px solid transparent;
      border-top-color: #ddf;
      border-bottom: 0;
      margin-bottom: -10px;
    }
    .pos {
      font-weight: 700;
      margin: 12px 0 6px;
      color: #444;
      text-transform: uppercase;
      font-size: 15px;
    }
    ul {
      padding-left: 20px;
      margin-top: 5px;
      list-style: none;
    }
    ul li {
      margin-left: 10px;
      padding: 4px 6px;
      border-left: 3px solid #ccc;
      margin-bottom: 5px;
      transition: background 0.2s ease;
      border-radius: 4px;
    }
    ul.recommended li { border-color: #4CAF50; background: #f0fff0; }
    ul.bench li { border-color: #F44336; background: #fff0f0; }
    ul.waiver li { border-color: #FF9800; background: #fff8e1; }
    @media (max-width: 600px) {
      .button-row {
        flex-direction: column;
      }
      button {
        width: 100%;
        font-size: 16px;
        padding: 12px;
      }
      h1 { font-size: 22px; }
      .player-row {
        flex-direction: column;
        gap: 4px;
      }
      .remove-player {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèà Fantasy GPT Coach</h1>

    <div id="config-area">
      <label>League Format</label>
      <select id="format">
        <option>Standard (Non-PPR)</option>
        <option selected>PPR</option>
        <option>Half-PPR</option>
        <option>2QB</option>
        <option>Superflex</option>
        <option>Dynasty PPR</option>
        <option>Custom</option>
      </select>

      <div id="custom-format-wrapper" style="display:none;">
        <label>Custom Format Details</label>
        <input id="custom-format" placeholder="e.g. TE Premium, 3 FLEX, IDP">
      </div>

      <label>Notes (Optional)</label>
      <input id="notes" placeholder="e.g. Good matchup, rain expected, injuries...">

      <div class="roster-section">
        <label>Build Your Roster</label>
        <div class="button-row">
          <button onclick="loadSampleRoster('ppr')">üìã Load PPR Sample</button>
          <button onclick="loadSampleRoster('2qb')">üìã Load 2QB Sample</button>
          <button onclick="clearRoster()">üßπ Clear All</button>
        </div>
        
        <div id="roster-builder">
          <!-- Roster positions will be dynamically generated here -->
        </div>
      </div>

      <button onclick="getAdvice()">üîç Get Lineup Advice</button>
    </div>

    <h2>üìã Advice</h2>
    <div id="output" class="output">Add some players to your roster above to get started!</div>

    <div id="challenge-area" style="margin-top:20px;display:none;">
      <label>Challenge the Coach</label>
      <textarea id="userChallenge" rows="2" placeholder="Ask the coach why he benched a player..."></textarea>
      <button style="background:#e53935; color:white;" onclick="challengeCoach()">üó£ Submit Challenge</button>
    </div>

    <button id="back-btn" style="display:none; margin-top:16px;" onclick="toggleConfig()">üîÑ Change Settings</button>

    <div id="rebuttal" class="output" style="margin-top:20px;display:none;"></div>

    <script>
      // Roster management
      let roster = {
        QB: [],
        RB: [],
        WR: [],
        TE: [],
        FLEX: [],
        BENCH: []
      };

      const positionLimits = {
        QB: 3,
        RB: 6,
        WR: 6,
        TE: 3,
        FLEX: 2,
        BENCH: 8
      };

      const sampleRosters = {
        ppr: {
          QB: ['Josh Allen'],
          RB: ['Christian McCaffrey', 'Saquon Barkley'],
          WR: ['Tyreek Hill', 'Stefon Diggs', 'Mike Evans'],
          TE: ['Travis Kelce'],
          FLEX: ['Tony Pollard'],
          BENCH: ['Tua Tagovailoa', 'James Conner', 'Jerry Jeudy']
        },
        '2qb': {
          QB: ['Josh Allen', 'Lamar Jackson'],
          RB: ['Austin Ekeler', 'Josh Jacobs'],
          WR: ['Cooper Kupp', 'Davante Adams'],
          TE: ['Mark Andrews'],
          FLEX: ['Amari Cooper'],
          BENCH: ['Geno Smith', 'Rhamondre Stevenson']
        }
      };

      document.getElementById("format").addEventListener("change", function() {
        document.getElementById("custom-format-wrapper").style.display =
          this.value === "Custom" ? "block" : "none";
      });

      function renderRosterBuilder() {
        const container = document.getElementById('roster-builder');
        container.innerHTML = '';

        Object.keys(positionLimits).forEach(position => {
          const positionDiv = document.createElement('div');
          positionDiv.className = 'position-group';
          
          const headerDiv = document.createElement('div');
          headerDiv.className = 'position-header';
          headerDiv.innerHTML = `
            ${position}
            <span class="position-count">${roster[position].length}/${positionLimits[position]}</span>
          `;
          positionDiv.appendChild(headerDiv);

          // Add existing players
          roster[position].forEach((player, index) => {
            const playerRow = document.createElement('div');
            playerRow.className = 'player-row';
            playerRow.innerHTML = `
              <input type="text" value="${player}" onchange="updatePlayer('${position}', ${index}, this.value)" placeholder="Enter player name">
              <button class="remove-player" onclick="removePlayer('${position}', ${index})">Remove</button>
            `;
            positionDiv.appendChild(playerRow);
          });

          // Add button to add more players
          if (roster[position].length < positionLimits[position]) {
            const addButton = document.createElement('button');
            addButton.className = 'add-player';
            addButton.textContent = `+ Add ${position}`;
            addButton.onclick = () => addPlayer(position);
            positionDiv.appendChild(addButton);
          }

          container.appendChild(positionDiv);
        });
      }

      function addPlayer(position) {
        if (roster[position].length < positionLimits[position]) {
          roster[position].push('');
          renderRosterBuilder();
          // Focus on the new input
          setTimeout(() => {
            const newInputs = document.querySelectorAll(`input[onchange*="${position}"]`);
            const lastInput = newInputs[newInputs.length - 1];
            if (lastInput) lastInput.focus();
          }, 100);
        }
      }

      function removePlayer(position, index) {
        roster[position].splice(index, 1);
        renderRosterBuilder();
      }

      function updatePlayer(position, index, value) {
        roster[position][index] = value;
      }

      function loadSampleRoster(type) {
        roster = JSON.parse(JSON.stringify(sampleRosters[type]));
        // Ensure all positions exist
        Object.keys(positionLimits).forEach(pos => {
          if (!roster[pos]) roster[pos] = [];
        });
        renderRosterBuilder();
      }

      function clearRoster() {
        Object.keys(roster).forEach(pos => {
          roster[pos] = [];
        });
        renderRosterBuilder();
      }

      function buildRosterJSON() {
        // Filter out empty player names and empty position arrays
        const cleanRoster = {};
        Object.keys(roster).forEach(pos => {
          const players = roster[pos].filter(p => p && p.trim() !== '');
          if (players.length > 0) {
            cleanRoster[pos] = players;
          }
        });
        return cleanRoster;
      }

      async function getAdvice() {
        const rosterData = buildRosterJSON();
        
        // Check if roster has any players
        if (Object.keys(rosterData).length === 0) {
          alert("‚ö†Ô∏è Please add some players to your roster first!");
          return;
        }

        document.getElementById("config-area").style.display = "none";
        document.getElementById("back-btn").style.display = "inline-block";
        const out = document.getElementById("output");
        out.innerHTML = "‚è≥ Thinking...";
        out.style.opacity = 1;

        const format = document.getElementById("format").value;
        const custom = document.getElementById("custom-format").value;
        const fullFormat = format === "Custom" ? `Custom: ${custom}` : format;
        const notes = document.getElementById("notes").value;

        try {
          const res = await fetch("/recommend", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ 
              scoring_format: fullFormat, 
              notes, 
              roster: rosterData 
            })
          });
          
          const data = await res.json();

          if (data.error) {
            out.innerHTML = "‚ö†Ô∏è " + data.error;
            return;
          }

          let html = '';
          Object.entries(data.recommended_starters).forEach(([pos, players]) => {
            html += `<div class="pos">${pos}</div><ul class="recommended">${players.map(p => `<li>${p}</li>`).join("")}</ul>`;
          });
          html += `<div class="pos">Bench</div><ul class="bench">${data.bench.map(p => `<li>${p}</li>`).join("")}</ul>`;
          html += `<div class="pos">Waiver</div><ul class="waiver">${data.waiver_watchlist.map(p => `<li>${p}</li>`).join("")}</ul>`;

          out.innerHTML = `<div class="bubble bubble-advice">${html}<p class="strategy">${data.strategy_summary}</p></div>`;
          document.getElementById("challenge-area").style.display = "block";
        } catch (error) {
          out.innerHTML = "‚ùå Failed to get advice. Please try again.";
          console.error('Error:', error);
        }
      }

      function toggleConfig() {
        document.getElementById("config-area").style.display = "block";
        document.getElementById("back-btn").style.display = "none";
        document.getElementById("challenge-area").style.display = "none";
        document.getElementById("rebuttal").style.display = "none";
        document.getElementById("output").innerHTML = "Add some players to your roster above to get started!";
      }

      async function challengeCoach() {
        const rebuttalBox = document.getElementById("rebuttal");
        const userPrompt = document.getElementById("userChallenge").value.trim();
        if (!userPrompt) {
          alert("‚ö†Ô∏è Enter a question for the coach.");
          return;
        }

        const format = document.getElementById("format").value;
        const custom = document.getElementById("custom-format").value;
        const fullFormat = format === "Custom" ? `Custom: ${custom}` : format;

        rebuttalBox.style.display = "block";
        rebuttalBox.style.opacity = 0;
        rebuttalBox.style.transform = "translateY(10px)";
        rebuttalBox.innerHTML = "üò§ Coach is preparing a response...";

        const starters = {};
        document.querySelectorAll(".recommended").forEach(ul => {
          const pos = ul.previousElementSibling?.textContent?.trim();
          starters[pos] = Array.from(ul.querySelectorAll("li")).map(li => li.textContent);
        });

        const bench = Array.from(document.querySelectorAll(".bench li")).map(li => li.textContent);
        const waiver = Array.from(document.querySelectorAll(".waiver li")).map(li => li.textContent);
        const summary = document.querySelector("p.strategy")?.textContent || "";

        try {
          const res = await fetch("/challenge", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ 
              advice: {
                recommended_starters: starters, 
                bench, 
                waiver_watchlist: waiver, 
                strategy_summary: summary
              }, 
              scoring_format: fullFormat, 
              user_challenge: userPrompt 
            })
          });
          const data = await res.json();
          rebuttalBox.innerHTML = data.error
            ? "‚ö†Ô∏è " + data.error
            : `<div class="bubble bubble-coach">üóØÔ∏è ${data.rebuttal}</div>`;
          rebuttalBox.style.opacity = 1;
          rebuttalBox.style.transform = "translateY(0)";
        } catch {
          rebuttalBox.innerHTML = "‚ùå Coach failed to respond.";
          rebuttalBox.style.opacity = 1;
          rebuttalBox.style.transform = "translateY(0)";
        }
      }

      // Initialize the roster builder on page load
      renderRosterBuilder();
    </script>

  </div>
</body>
</html>