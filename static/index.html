<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text',Helvetica,Arial,sans-serif&display=swap" rel="stylesheet">
  <title>Fantasy Football GPT Coach</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary-blue: #007AFF;
      --primary-blue-dark: #0056CC;
      --secondary-gray: #8E8E93;
      --background-primary: #F2F2F7;
      --background-secondary: #FFFFFF;
      --background-tertiary: #F9F9F9;
      --text-primary: #000000;
      --text-secondary: #3C3C43;
      --text-tertiary: #8E8E93;
      --border-color: #D1D1D6;
      --success-green: #34C759;
      --warning-orange: #FF9500;
      --error-red: #FF3B30;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-large: 0 4px 16px rgba(0,0,0,0.1);
      --radius: 12px;
      --radius-small: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', Helvetica, Arial, sans-serif;
      background: var(--background-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 16px;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 428px;
      margin: 0 auto;
      background: var(--background-secondary);
      border-radius: var(--radius);
      box-shadow: var(--shadow-large);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-blue), #5AC8FA);
      color: white;
      padding: 20px 24px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .header p {
      font-size: 16px;
      margin: 8px 0 0 0;
      opacity: 0.9;
      font-weight: 500;
    }

    .content {
      padding: 20px;
    }

    .section {
      margin-bottom: 24px;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .section-subtitle {
      font-size: 14px;
      color: var(--text-tertiary);
      margin: 4px 0 0 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 1.5px solid var(--border-color);
      border-radius: var(--radius-small);
      background: var(--background-secondary);
      color: var(--text-primary);
      transition: all 0.2s ease;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-small);
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      min-height: 44px;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-blue-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--background-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    .btn-success {
      background: var(--success-green);
      color: white;
    }

    .btn-warning {
      background: var(--warning-orange);
      color: white;
    }

    .btn-error {
      background: var(--error-red);
      color: white;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 14px;
      min-height: 36px;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-group .btn {
      flex: 1;
      min-width: 0;
    }

    .position-card {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }

    .position-card:hover {
      box-shadow: var(--shadow);
    }

    .position-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .position-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .position-count {
      background: var(--primary-blue);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .player-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: stretch;
    }

    .player-row input {
      flex: 1;
      margin-bottom: 0;
    }

    .player-row .btn {
      flex-shrink: 0;
      margin-bottom: 0;
    }

    .add-player-btn {
      width: 100%;
      margin-top: 8px;
      border: 2px dashed var(--border-color);
      background: transparent;
      color: var(--text-secondary);
    }

    .add-player-btn:hover:not(:disabled) {
      border-color: var(--primary-blue);
      color: var(--primary-blue);
      background: rgba(0, 122, 255, 0.05);
    }

    .output-card {
      background: var(--background-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      padding: 20px;
      margin-top: 24px;
      box-shadow: var(--shadow);
    }

    .loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px 20px;
    }

    .loading::before {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Compact Lineup Display */
    .lineup-container {
      display: grid;
      gap: 16px;
      margin: 16px 0;
    }

    .lineup-section {
      background: var(--background-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      overflow: hidden;
    }

    .lineup-header {
      background: var(--background-tertiary);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lineup-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0;
    }

    .lineup-badge {
      background: var(--primary-blue);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .lineup-badge.bench {
      background: var(--secondary-gray);
    }

    .lineup-badge.waiver {
      background: var(--warning-orange);
    }

    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1px;
      background: var(--border-color);
    }

    .player-card {
      background: var(--background-secondary);
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: background 0.2s ease;
      min-height: 60px;
      justify-content: center;
    }

    .player-card:hover {
      background: var(--background-tertiary);
    }

    .player-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .player-position {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 2px;
      font-weight: 500;
    }

    /* Starters Grid - Organized by Position */
    .starters-grid {
      display: grid;
      gap: 12px;
      margin: 16px 0;
    }

    .position-group-display {
      background: var(--background-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      overflow: hidden;
    }

    .position-group-header {
      background: linear-gradient(135deg, var(--primary-blue), #5AC8FA);
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .position-players {
      padding: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .starter-pill {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      flex: 1;
      min-width: 120px;
      text-align: center;
      transition: all 0.2s ease;
    }

    .starter-pill:hover {
      background: var(--primary-blue);
      color: white;
      transform: translateY(-1px);
    }

    /* Strategy Card */
    .strategy-card {
      background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
      border: 1px solid #BAE6FD;
      border-radius: var(--radius-small);
      padding: 16px;
      margin: 16px 0;
    }

    .strategy-card .strategy-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-blue);
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .strategy-card .strategy-text {
      font-size: 15px;
      line-height: 1.5;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Challenge Section Redesign */
    .challenge-card {
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      border: 1px solid #F59E0B;
      border-radius: var(--radius-small);
      padding: 16px;
      margin: 16px 0;
    }

    .challenge-title {
      font-size: 16px;
      font-weight: 700;
      color: #92400E;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      .player-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .starter-pill {
        min-width: 100px;
        font-size: 13px;
        padding: 6px 12px;
      }

      .position-players {
        flex-direction: column;
        gap: 6px;
      }

      .lineup-container {
        gap: 12px;
      }

      .strategy-card, .challenge-card {
        padding: 12px;
        margin: 12px 0;
      }

      .starters-grid {
        gap: 8px;
      }
    }

    .challenge-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    #custom-format-wrapper {
      margin-top: 12px;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #custom-format-wrapper.show {
      opacity: 1;
      max-height: 100px;
    }

    .back-btn {
      position: fixed;
      top: 50px;
      left: 24px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      z-index: 100;
      min-width: 44px;
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 22px;
    }

    /* Autocomplete Styles */
    .autocomplete-container {
      position: relative;
      flex: 1;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--background-secondary);
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 var(--radius-small) var(--radius-small);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: var(--shadow-large);
      display: none;
    }

    .autocomplete-dropdown.show {
      display: block;
    }

    .autocomplete-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .autocomplete-item:hover,
    .autocomplete-item.highlighted {
      background: var(--background-tertiary);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .player-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .player-position {
      font-size: 12px;
      color: var(--text-tertiary);
      background: var(--background-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .autocomplete-no-results {
      padding: 12px 16px;
      color: var(--text-tertiary);
      font-style: italic;
      text-align: center;
    }

    @media (max-width: 480px) {
      body {
        padding: 0;
      }
      
      .container {
        border-radius: 0;
        min-height: 100vh;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .player-row {
        flex-direction: column;
        gap: 8px;
      }

      .autocomplete-dropdown {
        max-height: 160px;
        font-size: 16px; /* Prevent zoom on iOS */
      }

      .autocomplete-item {
        padding: 14px 16px;
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🏈 Fantasy GPT Coach</h1>
      <p>AI-powered lineup optimization</p>
    </div>

    <div class="content">
      <div id="config-area">
        <div class="section">
          <div class="form-group">
            <label>League Format</label>
            <select id="format">
              <option>Standard (Non-PPR)</option>
              <option selected>PPR</option>
              <option>Half-PPR</option>
              <option>2QB</option>
              <option>Superflex</option>
              <option>Dynasty PPR</option>
              <option>Custom</option>
            </select>
            <div id="custom-format-wrapper">
              <input id="custom-format" placeholder="e.g. TE Premium, 3 FLEX, IDP">
            </div>
          </div>

          <div class="form-group">
            <label>Additional Notes</label>
            <textarea id="notes" rows="2" placeholder="Weather concerns, injury updates, tough matchups..."></textarea>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <div>
              <h2 class="section-title">Build Your Roster</h2>
              <p class="section-subtitle">Add your players by position</p>
            </div>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-secondary btn-small" onclick="loadSampleRoster('ppr')">📋 PPR Sample</button>
            <button class="btn btn-secondary btn-small" onclick="loadSampleRoster('2qb')">📋 2QB Sample</button>
            <button class="btn btn-secondary btn-small" onclick="clearRoster()">🧹 Clear All</button>
          </div>
          
          <div id="roster-builder">
            <!-- Roster positions will be dynamically generated here -->
          </div>
        </div>

        <button class="btn btn-primary" style="width: 100%;" onclick="getAdvice()">
          🎯 Get Lineup Advice
        </button>
      </div>

      <div id="output" class="output-card" style="display: none;">
        <!-- Advice will appear here -->
      </div>

      <div id="challenge-area" class="challenge-section" style="display: none;">
        <div class="strategy-card" style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-color: #F59E0B;">
          <h3 style="color: #92400E; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">🗣 Challenge the Coach</h3>
          <textarea id="userChallenge" rows="2" placeholder="Why did you bench my star player?" style="margin-bottom: 12px;"></textarea>
          <button class="btn btn-warning" style="width: 100%;" onclick="challengeCoach()">
            Submit Challenge
          </button>
        </div>
      </div>

      <div id="rebuttal" class="output-card" style="display: none;">
        <!-- Coach rebuttal will appear here -->
      </div>
    </div>

    <button id="back-btn" class="btn btn-secondary back-btn" style="display: none;" onclick="toggleConfig()">
      ←
    </button>
  </div>

  <script>
    // NFL Player Database (2025 Season - Updated with 2024 & 2025 Rookies)
    const playerDatabase = {
      QB: [
        // Established Veterans
        'Josh Allen', 'Lamar Jackson', 'Patrick Mahomes', 'Joe Burrow', 'Jalen Hurts',
        'Justin Herbert', 'Dak Prescott', 'Tua Tagovailoa', 'Kyler Murray', 'Russell Wilson',
        'Aaron Rodgers', 'Geno Smith', 'Kirk Cousins', 'Trevor Lawrence', 'Anthony Richardson',
        'Brock Purdy', 'Jared Goff', 'Daniel Jones', 'Derek Carr', 'Justin Fields',
        'C.J. Stroud', 'Kenny Pickett', 'Deshaun Watson', 'Ryan Tannehill', 'Mac Jones',
        'Bryce Young', 'Will Levis', 'Sam Howell', 'Baker Mayfield', 'Jordan Love',
        'Aidan O\'Connell', 'Tommy DeVito', 'Mason Rudolph', 'Gardner Minshew', 'Jacoby Brissett',
        
        // 2024 Rookies (Now Second Year)
        'Jayden Daniels', 'Caleb Williams', 'Drake Maye', 'Bo Nix', 'J.J. McCarthy', 'Michael Penix Jr.',
        
        // 2025 Rookies
        'Cam Ward', 'Dillon Gabriel', 'Shedeur Sanders', 'Jalen Milroe', 'Quinn Ewers',
        'Kyle McCord', 'Tyler Shough', 'Will Howard', 'Aidan Chiles', 'Thomas Castellanos'
      ],
      RB: [
        // Established Veterans
        'Christian McCaffrey', 'Austin Ekeler', 'Derrick Henry', 'Josh Jacobs', 'Nick Chubb',
        'Saquon Barkley', 'Tony Pollard', 'Aaron Jones', 'Joe Mixon', 'Kenneth Walker III',
        'Najee Harris', 'Alvin Kamara', 'Ezekiel Elliott', 'Miles Sanders', 'David Montgomery',
        'Rhamondre Stevenson', 'James Conner', 'Travis Etienne', 'D\'Andre Swift', 'Javonte Williams',
        'Alexander Mattison', 'Rachaad White', 'Jerome Ford', 'Isiah Pacheco', 'Breece Hall',
        'Jonathan Taylor', 'Cam Akers', 'Khalil Herbert', 'Zamir White', 'Tyler Allgeier',
        'James Cook', 'Brian Robinson Jr.', 'Gus Edwards', 'Chuba Hubbard', 'Roschon Johnson',
        'Antonio Gibson', 'Tank Bigsby', 'Jaylen Warren', 'Justice Hill', 'Rico Dowdle',
        'Dameon Pierce', 'Kenneth Gainwell', 'Devin Singletary', 'Elijah Mitchell', 'Jordan Mason',
        'Ty Chandler', 'AJ Dillon', 'Samaje Perine', 'Clyde Edwards-Helaire', 'Zack Moss',
        
        // 2024 Rookies (Now Second Year)
        'Jayden Reed', 'Blake Corum', 'Trey Benson', 'MarShawn Lloyd', 'Jaylen Wright',
        'Braelon Allen', 'Jonathon Brooks', 'Ray Davis', 'Kimani Vidal', 'Isaac Guerendo',
        
        // 2025 Rookies  
        'Ashton Jeanty', 'Omarion Hampton', 'Quinshon Judkins', 'Dylan Sampson', 'Cam Skattebo',
        'TreVeyon Henderson', 'Nicholas Singleton', 'Kaleb Johnson', 'RJ Harvey', 'Woody Marks'
      ],
      WR: [
        // Established Veterans
        'Tyreek Hill', 'Stefon Diggs', 'Davante Adams', 'Cooper Kupp', 'DeAndre Hopkins',
        'A.J. Brown', 'Mike Evans', 'Keenan Allen', 'Amari Cooper', 'Tyler Lockett',
        'DK Metcalf', 'CeeDee Lamb', 'Ja\'Marr Chase', 'Justin Jefferson', 'Amon-Ra St. Brown',
        'Puka Nacua', 'Chris Olave', 'Garrett Wilson', 'Jaylen Waddle', 'Terry McLaurin',
        'Calvin Ridley', 'DJ Moore', 'Michael Pittman Jr.', 'Courtland Sutton', 'Tee Higgins',
        'Mike Williams', 'Jerry Jeudy', 'Diontae Johnson', 'Christian Kirk', 'Marquise Goodwin',
        'Drake London', 'Chris Godwin', 'Brandon Aiyuk', 'Deebo Samuel', 'Rashod Bateman',
        'Elijah Moore', 'Gabe Davis', 'Curtis Samuel', 'Adam Thielen', 'Jordan Addison',
        'Tank Dell', 'Nico Collins', 'George Pickens', 'Christian Watson', 'Romeo Doubs',
        'DeVonta Smith', 'Zay Flowers', 'Rashee Rice', 'Josh Palmer', 'Tutu Atwell',
        'Darius Slayton', 'Noah Brown', 'Wan\'Dale Robinson', 'Isaiah Hodgins', 'Donovan Peoples-Jones',
        
        // 2024 Rookies (Now Second Year)
        'Malik Nabers', 'Jayden Reed', 'Rome Odunze', 'Marvin Harrison Jr.', 'Brian Thomas Jr.',
        'Xavier Worthy', 'Ladd McConkey', 'Keon Coleman', 'Xavier Legette', 'Adonai Mitchell',
        'Ricky Pearsall', 'Ja\'Lynn Polk', 'Luke McCaffrey', 'Jalen McMillan', 'Troy Franklin',
        
        // 2025 Rookies
        'Travis Hunter', 'Matthew Golden', 'Emeka Egbuka', 'Tetairoa McMillan', 'Luther Burden III',
        'Elic Ayomanor', 'Jaylin Noel', 'Jayden Higgins', 'Jalen Royals', 'Isaiah Bond',
        'Savion Williams', 'Jaylin Lane', 'Tai Felton', 'Jeshaun Jones', 'Kevin Concepcion'
      ],
      TE: [
        // Established Veterans
        'Travis Kelce', 'Mark Andrews', 'T.J. Hockenson', 'George Kittle', 'Darren Waller',
        'Kyle Pitts', 'Dallas Goedert', 'Evan Engram', 'Sam LaPorta', 'David Njoku',
        'Pat Freiermuth', 'Tyler Higbee', 'Gerald Everett', 'Cole Kmet', 'Dawson Knox',
        'Jake Ferguson', 'Noah Fant', 'Hayden Hurst', 'Logan Thomas', 'Hunter Henry',
        'Mike Gesicki', 'Isaiah Likely', 'Chigoziem Okonkwo', 'Luke Musgrave', 'Tucker Kraft',
        'Juwan Johnson', 'Durham Smythe', 'Will Dissly', 'Irv Smith Jr.', 'Tyler Conklin',
        'Trey McBride', 'Daniel Bellinger', 'Greg Dulcich', 'Cade Otton', 'Foster Moreau',
        
        // 2024 Rookies (Now Second Year)
        'Brock Bowers', 'Ja\'Tavion Sanders', 'Ben Sinnott', 'Theo Johnson', 'Erick All Jr.',
        'Dalton Kincaid', 'Michael Mayer',
        
        // 2025 Rookies
        'Tyler Warren', 'Colston Loveland', 'Harold Fannin Jr.', 'Mitchell Evans', 'Oscar Delp',
        'Gunnar Helm', 'Jake Briningstool', 'Eli Stowers', 'Nick Elksnis', 'Walker Lyons'
      ]
    };

    // Roster management
    let roster = {
      QB: [],
      RB: [],
      WR: [],
      TE: [],
      FLEX: [],
      BENCH: []
    };

    const positionLimits = {
      QB: 3,
      RB: 6,
      WR: 6,
      TE: 3,
      FLEX: 2,
      BENCH: 8
    };

    const sampleRosters = {
      ppr: {
        QB: ['Josh Allen'],
        RB: ['Christian McCaffrey', 'Saquon Barkley'],
        WR: ['Tyreek Hill', 'Stefon Diggs', 'Mike Evans'],
        TE: ['Travis Kelce'],
        FLEX: ['Tony Pollard'],
        BENCH: ['Tua Tagovailoa', 'James Conner', 'Jerry Jeudy']
      },
      '2qb': {
        QB: ['Josh Allen', 'Lamar Jackson'],
        RB: ['Austin Ekeler', 'Josh Jacobs'],
        WR: ['Cooper Kupp', 'Davante Adams'],
        TE: ['Mark Andrews'],
        FLEX: ['Amari Cooper'],
        BENCH: ['Geno Smith', 'Rhamondre Stevenson']
      }
    };

    // Autocomplete functionality
    function createDropdown() {
      const dropdown = document.createElement('div');
      dropdown.className = 'autocomplete-dropdown';
      return dropdown;
    }

    function getRelevantPlayers(position, query) {
      // For FLEX and BENCH, include RB, WR, TE
      let availablePlayers = [];
      
      if (position === 'FLEX' || position === 'BENCH') {
        availablePlayers = [
          ...playerDatabase.RB,
          ...playerDatabase.WR, 
          ...playerDatabase.TE
        ];
      } else if (playerDatabase[position]) {
        availablePlayers = playerDatabase[position];
      } else {
        // Fallback for any position
        availablePlayers = Object.values(playerDatabase).flat();
      }

      // Filter by query
      if (!query || query.length < 1) return [];
      
      const filtered = availablePlayers.filter(player => 
        player.toLowerCase().includes(query.toLowerCase())
      );
      
      // Sort by relevance (starts with query first, then contains)
      filtered.sort((a, b) => {
        const aStarts = a.toLowerCase().startsWith(query.toLowerCase());
        const bStarts = b.toLowerCase().startsWith(query.toLowerCase());
        if (aStarts && !bStarts) return -1;
        if (!aStarts && bStarts) return 1;
        return a.localeCompare(b);
      });
      
      return filtered.slice(0, 8); // Limit results
    }

    function getPlayerPosition(playerName) {
      for (const [position, players] of Object.entries(playerDatabase)) {
        if (players.includes(playerName)) {
          return position;
        }
      }
      return '';
    }

    function setupAutocomplete(input, position, index) {
      const dropdown = input.parentNode.querySelector('.autocomplete-dropdown');
      let highlightedIndex = -1;
      let currentResults = [];

      function showDropdown(results) {
        currentResults = results;
        dropdown.innerHTML = '';
        
        if (results.length === 0) {
          const noResults = document.createElement('div');
          noResults.className = 'autocomplete-no-results';
          noResults.textContent = 'No players found';
          dropdown.appendChild(noResults);
        } else {
          results.forEach((player, idx) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            if (idx === highlightedIndex) {
              item.classList.add('highlighted');
            }
            
            const playerPos = getPlayerPosition(player);
            item.innerHTML = `
              <span class="player-name">${player}</span>
              <span class="player-position">${playerPos}</span>
            `;
            
            item.onclick = () => selectPlayer(player);
            dropdown.appendChild(item);
          });
        }
        
        dropdown.classList.add('show');
      }

      function hideDropdown() {
        dropdown.classList.remove('show');
        highlightedIndex = -1;
      }

      function selectPlayer(playerName) {
        input.value = playerName;
        updatePlayer(position, index, playerName);
        hideDropdown();
        input.blur();
      }

      function updateHighlight() {
        const items = dropdown.querySelectorAll('.autocomplete-item:not(.autocomplete-no-results)');
        items.forEach((item, idx) => {
          item.classList.toggle('highlighted', idx === highlightedIndex);
        });
      }

      // Input event handler
      input.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        updatePlayer(position, index, query);
        
        if (query.length >= 1) {
          const results = getRelevantPlayers(position, query);
          showDropdown(results);
          highlightedIndex = -1;
        } else {
          hideDropdown();
        }
      });

      // Keyboard navigation
      input.addEventListener('keydown', (e) => {
        const items = dropdown.querySelectorAll('.autocomplete-item:not(.autocomplete-no-results)');
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
            updateHighlight();
            break;
          case 'ArrowUp':
            e.preventDefault();
            highlightedIndex = Math.max(highlightedIndex - 1, -1);
            updateHighlight();
            break;
          case 'Enter':
            e.preventDefault();
            if (highlightedIndex >= 0 && currentResults[highlightedIndex]) {
              selectPlayer(currentResults[highlightedIndex]);
            }
            break;
          case 'Escape':
            hideDropdown();
            input.blur();
            break;
        }
      });

      // Focus/blur events
      input.addEventListener('focus', () => {
        const query = input.value.trim();
        if (query.length >= 1) {
          const results = getRelevantPlayers(position, query);
          showDropdown(results);
        }
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!input.parentNode.contains(e.target)) {
          hideDropdown();
        }
      });
    }

    document.getElementById("format").addEventListener("change", function() {
      const customWrapper = document.getElementById("custom-format-wrapper");
      if (this.value === "Custom") {
        customWrapper.classList.add("show");
      } else {
        customWrapper.classList.remove("show");
      }
    });

    function renderRosterBuilder() {
      const container = document.getElementById('roster-builder');
      container.innerHTML = '';

      Object.keys(positionLimits).forEach(position => {
        const positionCard = document.createElement('div');
        positionCard.className = 'position-card';
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'position-header';
        headerDiv.innerHTML = `
          <span class="position-title">${position}</span>
          <span class="position-count">${roster[position].length}/${positionLimits[position]}</span>
        `;
        positionCard.appendChild(headerDiv);

        // Add existing players
        roster[position].forEach((player, index) => {
          const playerRow = document.createElement('div');
          playerRow.className = 'player-row';
          
          const autocompleteContainer = document.createElement('div');
          autocompleteContainer.className = 'autocomplete-container';
          
          const input = document.createElement('input');
          input.type = 'text';
          input.value = player;
          input.placeholder = 'Enter player name';
          input.setAttribute('data-position', position);
          input.setAttribute('data-index', index);
          
          autocompleteContainer.appendChild(input);
          autocompleteContainer.appendChild(createDropdown());
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn-error btn-small';
          removeBtn.textContent = '×';
          removeBtn.onclick = () => removePlayer(position, index);
          
          playerRow.appendChild(autocompleteContainer);
          playerRow.appendChild(removeBtn);
          positionCard.appendChild(playerRow);
          
          // Setup autocomplete for this input
          setupAutocomplete(input, position, index);
        });

        // Add button to add more players
        if (roster[position].length < positionLimits[position]) {
          const addButton = document.createElement('button');
          addButton.className = 'btn add-player-btn';
          addButton.textContent = `+ Add ${position}`;
          addButton.onclick = () => addPlayer(position);
          positionCard.appendChild(addButton);
        }

        container.appendChild(positionCard);
      });
    }

    function addPlayer(position) {
      if (roster[position].length < positionLimits[position]) {
        roster[position].push('');
        renderRosterBuilder();
        // Focus on the new input with a slight delay
        setTimeout(() => {
          const allInputs = document.querySelectorAll(`input[data-position="${position}"]`);
          const lastInput = allInputs[allInputs.length - 1];
          if (lastInput) {
            lastInput.focus();
          }
        }, 100);
      }
    }

    function removePlayer(position, index) {
      roster[position].splice(index, 1);
      renderRosterBuilder();
    }

    function updatePlayer(position, index, value) {
      roster[position][index] = value;
    }

    function loadSampleRoster(type) {
      roster = JSON.parse(JSON.stringify(sampleRosters[type]));
      // Ensure all positions exist
      Object.keys(positionLimits).forEach(pos => {
        if (!roster[pos]) roster[pos] = [];
      });
      renderRosterBuilder();
    }

    function clearRoster() {
      Object.keys(roster).forEach(pos => {
        roster[pos] = [];
      });
      renderRosterBuilder();
    }

    function buildRosterJSON() {
      // Filter out empty player names and empty position arrays
      const cleanRoster = {};
      Object.keys(roster).forEach(pos => {
        const players = roster[pos].filter(p => p && p.trim() !== '');
        if (players.length > 0) {
          cleanRoster[pos] = players;
        }
      });
      return cleanRoster;
    }

    async function getAdvice() {
      const rosterData = buildRosterJSON();
      
      // Check if roster has any players
      if (Object.keys(rosterData).length === 0) {
        alert("⚠️ Please add some players to your roster first!");
        return;
      }

      document.getElementById("config-area").style.display = "none";
      document.getElementById("back-btn").style.display = "block";
      
      const outputDiv = document.getElementById("output");
      outputDiv.style.display = "block";
      outputDiv.className = "output-card loading fade-in";
      outputDiv.innerHTML = "Analyzing your roster and matchups...";

      const format = document.getElementById("format").value;
      const custom = document.getElementById("custom-format").value;
      const fullFormat = format === "Custom" ? `Custom: ${custom}` : format;
      const notes = document.getElementById("notes").value;

      try {
        const res = await fetch("/recommend", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ 
            scoring_format: fullFormat, 
            notes, 
            roster: rosterData 
          })
        });
        
        const data = await res.json();

        if (data.error) {
          outputDiv.className = "output-card";
          outputDiv.innerHTML = `<div style="color: var(--error-red);">⚠️ ${data.error}</div>`;
          return;
        }

        // Build the new compact lineup display
        let html = '<div class="lineup-container">';
        
        // Starting Lineup - Organized by Position
        html += '<div class="starters-grid">';
        Object.entries(data.recommended_starters).forEach(([pos, players]) => {
          html += `
            <div class="position-group-display">
              <div class="position-group-header">${pos}</div>
              <div class="position-players">
                ${players.map(p => `<div class="starter-pill">${p}</div>`).join('')}
              </div>
            </div>
          `;
        });
        html += '</div>';

        // Bench Section
        if (data.bench && data.bench.length > 0) {
          html += `
            <div class="lineup-section">
              <div class="lineup-header">
                <h3 class="lineup-title">Bench</h3>
                <span class="lineup-badge bench">${data.bench.length}</span>
              </div>
              <div class="player-grid">
                ${data.bench.map(p => `
                  <div class="player-card">
                    <div class="player-name">${p}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        // Waiver Watch Section
        if (data.waiver_watchlist && data.waiver_watchlist.length > 0) {
          html += `
            <div class="lineup-section">
              <div class="lineup-header">
                <h3 class="lineup-title">Waiver Watch</h3>
                <span class="lineup-badge waiver">${data.waiver_watchlist.length}</span>
              </div>
              <div class="player-grid">
                ${data.waiver_watchlist.map(p => `
                  <div class="player-card">
                    <div class="player-name">${p}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        // Strategy Section
        html += `
          <div class="strategy-card">
            <h3 class="strategy-title">🧠 Strategy Notes</h3>
            <p class="strategy-text">${data.strategy_summary}</p>
          </div>
        `;

        html += '</div>';

        outputDiv.className = "output-card fade-in";
        outputDiv.innerHTML = html;
        document.getElementById("challenge-area").style.display = "block";
      } catch (error) {
        outputDiv.className = "output-card";
        outputDiv.innerHTML = '<div style="color: var(--error-red);">❌ Failed to get advice. Please try again.</div>';
        console.error('Error:', error);
      }
    }

    function toggleConfig() {
      document.getElementById("config-area").style.display = "block";
      document.getElementById("back-btn").style.display = "none";
      document.getElementById("challenge-area").style.display = "none";
      document.getElementById("rebuttal").style.display = "none";
      document.getElementById("output").style.display = "none";
    }

    async function challengeCoach() {
      const rebuttalBox = document.getElementById("rebuttal");
      const userPrompt = document.getElementById("userChallenge").value.trim();
      if (!userPrompt) {
        alert("⚠️ Enter a question for the coach.");
        return;
      }

      const format = document.getElementById("format").value;
      const custom = document.getElementById("custom-format").value;
      const fullFormat = format === "Custom" ? `Custom: ${custom}` : format;

      rebuttalBox.style.display = "block";
      rebuttalBox.className = "output-card loading fade-in";
      rebuttalBox.innerHTML = "Coach is preparing a response...";

      const starters = {};
      document.querySelectorAll(".player-list:not(.bench):not(.waiver)").forEach(ul => {
        const pos = ul.previousElementSibling?.textContent?.trim();
        if (pos) {
          starters[pos] = Array.from(ul.querySelectorAll("li")).map(li => li.textContent);
        }
      });

      const bench = Array.from(document.querySelectorAll(".player-list.bench li")).map(li => li.textContent);
      const waiver = Array.from(document.querySelectorAll(".player-list.waiver li")).map(li => li.textContent);
      const summary = document.querySelector(".strategy-summary")?.textContent || "";

      try {
        const res = await fetch("/challenge", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ 
            advice: {
              recommended_starters: starters, 
              bench, 
              waiver_watchlist: waiver, 
              strategy_summary: summary
            }, 
            scoring_format: fullFormat, 
            user_challenge: userPrompt 
          })
        });
        const data = await res.json();
        
        rebuttalBox.className = "output-card fade-in";
        rebuttalBox.innerHTML = data.error
          ? `<div style="color: var(--error-red);">⚠️ ${data.error}</div>`
          : `<div class="challenge-card">
               <h3 class="challenge-title">🗯️ Coach's Response</h3>
               <p style="margin: 0; line-height: 1.5; color: #92400E;">${data.rebuttal}</p>
             </div>`;
      } catch {
        rebuttalBox.className = "output-card";
        rebuttalBox.innerHTML = '<div style="color: var(--error-red);">❌ Coach failed to respond.</div>';
      }
    }

    // Initialize the roster builder on page load
    renderRosterBuilder();
  </script>
</div>
</body>
</html>