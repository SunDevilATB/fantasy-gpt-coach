<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text',Helvetica,Arial,sans-serif&display=swap" rel="stylesheet">
  <title>Fantasy Football GPT Coach</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary-blue: #007AFF;
      --primary-blue-dark: #0056CC;
      --secondary-gray: #8E8E93;
      --background-primary: #F2F2F7;
      --background-secondary: #FFFFFF;
      --background-tertiary: #F9F9F9;
      --text-primary: #000000;
      --text-secondary: #3C3C43;
      --text-tertiary: #8E8E93;
      --border-color: #D1D1D6;
      --success-green: #34C759;
      --warning-orange: #FF9500;
      --error-red: #FF3B30;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-large: 0 4px 16px rgba(0,0,0,0.1);
      --radius: 12px;
      --radius-small: 8px;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --primary-blue: #0A84FF;
      --primary-blue-dark: #0969DA;
      --secondary-gray: #98989D;
      --background-primary: #000000;
      --background-secondary: #1C1C1E;
      --background-tertiary: #2C2C2E;
      --text-primary: #FFFFFF;
      --text-secondary: #EBEBF5;
      --text-tertiary: #8E8E93;
      --border-color: #38383A;
      --success-green: #30D158;
      --warning-orange: #FF9F0A;
      --error-red: #FF453A;
      --shadow: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-large: 0 4px 16px rgba(0,0,0,0.3);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', Helvetica, Arial, sans-serif;
      background: var(--background-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 16px;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .container {
      max-width: 428px;
      margin: 0 auto;
      background: var(--background-secondary);
      border-radius: var(--radius);
      box-shadow: var(--shadow-large);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-blue), #5AC8FA);
      color: white;
      padding: 20px 24px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .header p {
      font-size: 16px;
      margin: 8px 0 0 0;
      opacity: 0.9;
      font-weight: 500;
    }

    /* Dark mode toggle */
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 40px;
      height: 40px;
      transition: background-color 0.2s ease;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .content {
      padding: 20px;
    }

    .section {
      margin-bottom: 24px;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .section-subtitle {
      font-size: 14px;
      color: var(--text-tertiary);
      margin: 4px 0 0 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 1.5px solid var(--border-color);
      border-radius: var(--radius-small);
      background: var(--background-secondary);
      color: var(--text-primary);
      transition: all 0.2s ease;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-small);
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      min-height: 44px;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-blue-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--background-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    .btn-success {
      background: var(--success-green);
      color: white;
    }

    .btn-warning {
      background: var(--warning-orange);
      color: white;
    }

    .btn-error {
      background: var(--error-red);
      color: white;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 14px;
      min-height: 36px;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-group .btn {
      flex: 1;
      min-width: 0;
    }

    .btn-group select {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
    }

    .btn-group select:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .position-card {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }

    .position-card:hover {
      box-shadow: var(--shadow);
    }

    .position-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .position-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .position-count {
      background: var(--primary-blue);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .player-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: stretch;
    }

    .player-row input {
      flex: 1;
      margin-bottom: 0;
    }

    .player-row .btn {
      flex-shrink: 0;
      margin-bottom: 0;
    }

    .add-player-btn {
      width: 100%;
      margin-top: 8px;
      border: 2px dashed var(--border-color);
      background: transparent;
      color: var(--text-secondary);
    }

    .add-player-btn:hover:not(:disabled) {
      border-color: var(--primary-blue);
      color: var(--primary-blue);
      background: rgba(0, 122, 255, 0.05);
    }

    .output-card {
      background: var(--background-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      padding: 20px;
      margin-top: 24px;
      box-shadow: var(--shadow);
    }

    .loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px 20px;
    }

    .loading::before {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Compact Lineup Display */
    .lineup-container {
      display: grid;
      gap: 16px;
      margin: 16px 0;
    }

    .lineup-section {
      background: var(--background-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      overflow: hidden;
    }

    .lineup-header {
      background: var(--background-tertiary);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lineup-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0;
    }

    .lineup-badge {
      background: var(--primary-blue);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .lineup-badge.bench {
      background: var(--secondary-gray);
    }

    .lineup-badge.waiver {
      background: var(--warning-orange);
    }

    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1px;
      background: var(--border-color);
    }

    .player-card {
      background: var(--background-secondary);
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: background 0.2s ease;
      min-height: 60px;
      justify-content: center;
      position: relative;
    }

    .player-card:hover {
      background: var(--background-tertiary);
    }

    .player-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.2;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .player-position {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 2px;
      font-weight: 500;
    }

    /* Injury Status */
    .injury-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }

    .injury-dot.healthy {
      background: var(--success-green);
    }

    .injury-dot.questionable {
      background: var(--warning-orange);
    }

    .injury-dot.doubtful {
      background: var(--error-red);
    }

    .injury-dot.out {
      background: #8E8E93;
    }

    .injury-badge {
      background: var(--error-red);
      color: white;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
      margin-left: 4px;
      font-weight: 600;
    }

    /* Weather Alert */
    .weather-alert {
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      border: 1px solid var(--warning-orange);
      border-radius: var(--radius-small);
      padding: 12px;
      margin: 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .weather-alert .weather-icon {
      font-size: 18px;
    }

    .weather-alert .weather-text {
      font-size: 14px;
      color: #92400E;
      font-weight: 600;
    }

    /* Defense Rankings */
    .defense-ranking {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      padding: 12px;
      margin: 8px 0;
    }

    .defense-ranking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .defense-ranking-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    .defense-rank {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .defense-rank.good {
      background: var(--success-green);
      color: white;
    }

    .defense-rank.average {
      background: var(--warning-orange);
      color: white;
    }

    .defense-rank.bad {
      background: var(--error-red);
      color: white;
    }

    /* Starters Grid - Organized by Position */
    .starters-grid {
      display: grid;
      gap: 12px;
      margin: 16px 0;
    }

    .position-group-display {
      background: var(--background-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      overflow: hidden;
    }

    .position-group-header {
      background: linear-gradient(135deg, var(--primary-blue), #5AC8FA);
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .position-players {
      padding: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .starter-pill {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      flex: 1;
      min-width: 120px;
      text-align: center;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .starter-pill:hover {
      background: var(--primary-blue);
      color: white;
      transform: translateY(-1px);
    }

    /* Strategy Card */
    .strategy-card {
      background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
      border: 1px solid #BAE6FD;
      border-radius: var(--radius-small);
      padding: 16px;
      margin: 16px 0;
    }

    .strategy-card .strategy-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-blue);
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .strategy-card .strategy-text {
      font-size: 15px;
      line-height: 1.5;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Challenge Section Redesign */
    .challenge-card {
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      border: 1px solid #F59E0B;
      border-radius: var(--radius-small);
      padding: 16px;
      margin: 16px 0;
    }

    .challenge-title {
      font-size: 16px;
      font-weight: 700;
      color: #92400E;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Collapsible Sections */
    .section-collapsible {
      margin: 16px 0;
    }

    .section-toggle {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
      user-select: none;
    }

    .section-toggle:hover {
      background: var(--border-color);
    }

    .section-toggle.collapsed {
      border-radius: var(--radius-small);
    }

    .section-toggle.expanded {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom: none;
    }

    .section-toggle-title {
      font-weight: 700;
      font-size: 16px;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-toggle-icon {
      font-size: 14px;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .section-toggle.expanded .section-toggle-icon {
      transform: rotate(180deg);
    }

    .section-content {
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 var(--radius-small) var(--radius-small);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .section-content.collapsed {
      max-height: 0;
      opacity: 0;
      border: none;
    }

    .section-content.expanded {
      max-height: 2000px;
      opacity: 1;
    }

    .section-content-inner {
      padding: 16px;
    }

    /* Confidence Scores */
    .confidence-score {
      background: var(--background-secondary);
      color: var(--text-primary);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: 6px;
      border: 1px solid var(--border-color);
    }

    .confidence-score.high {
      background: var(--success-green);
      color: white;
    }

    .confidence-score.medium {
      background: var(--warning-orange);
      color: white;
    }

    .confidence-score.low {
      background: var(--error-red);
      color: white;
    }

    /* Player Click Interactions */
    .starter-pill.clickable {
      cursor: pointer;
      border: 2px solid transparent;
    }

    .starter-pill.clickable:hover {
      border-color: var(--primary-blue);
      background: var(--primary-blue);
      color: white;
      transform: translateY(-2px);
    }

    .player-challenge-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .player-challenge-modal.show {
      display: flex;
    }

    .player-challenge-content {
      background: var(--background-secondary);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--shadow-large);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .player-challenge-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .player-challenge-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .player-challenge-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .player-challenge-close:hover {
      color: var(--text-primary);
    }

    .challenge-suggestions {
      display: grid;
      gap: 8px;
      margin-bottom: 16px;
    }

    .challenge-suggestion {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      text-align: left;
    }

    .challenge-suggestion:hover {
      background: var(--primary-blue);
      color: white;
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      body {
        padding: 0;
      }
      
      .container {
        border-radius: 0;
        min-height: 100vh;
      }
      
      .player-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .starter-pill {
        min-width: 100px;
        font-size: 13px;
        padding: 6px 12px;
      }

      .position-players {
        flex-direction: column;
        gap: 6px;
      }

      .lineup-container {
        gap: 12px;
      }

      .strategy-card, .challenge-card {
        padding: 12px;
        margin: 12px 0;
      }

      .starters-grid {
        gap: 8px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn-group select {
        order: -1; /* Put dropdown first on mobile */
      }
      
      .player-row {
        gap: 6px;
      }
      
      .player-row input {
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .remove-player {
        padding: 8px 10px;
        font-size: 14px;
        min-width: 40px;
      }

      .autocomplete-dropdown {
        max-height: 160px;
        font-size: 16px; /* Prevent zoom on iOS */
      }

      .autocomplete-item {
        padding: 14px 16px;
      }
    }

    .challenge-section {
      margin-top: 20px;
      padding-top: 0;
    }

    #custom-format-wrapper {
      margin-top: 12px;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #custom-format-wrapper.show {
      opacity: 1;
      max-height: 100px;
    }

    .back-btn {
      position: fixed;
      top: 50px;
      left: 24px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      z-index: 100;
      min-width: 44px;
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 22px;
    }

    [data-theme="dark"] .back-btn {
      background: rgba(28, 28, 30, 0.9);
      color: var(--text-primary);
    }

    /* Autocomplete Styles */
    .autocomplete-container {
      position: relative;
      flex: 1;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--background-secondary);
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 var(--radius-small) var(--radius-small);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: var(--shadow-large);
      display: none;
    }

    .autocomplete-dropdown.show {
      display: block;
    }

    .autocomplete-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .autocomplete-item:hover,
    .autocomplete-item.highlighted {
      background: var(--background-tertiary);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-no-results {
      padding: 12px 16px;
      color: var(--text-tertiary);
      font-style: italic;
      text-align: center;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Weather conditions */
    .weather-conditions {
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-small);
      padding: 12px;
      margin: 16px 0;
    }

    .weather-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .weather-games {
      display: grid;
      gap: 8px;
    }

    .weather-game {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: var(--background-secondary);
      border-radius: 6px;
      font-size: 14px;
    }

    .weather-game.bad {
      border-left: 4px solid var(--error-red);
    }

    .weather-game.moderate {
      border-left: 4px solid var(--warning-orange);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
        üåô
      </button>
      <h1>üèà Fantasy GPT Coach</h1>
      <p>AI-powered lineup optimization</p>
    </div>

    <div class="content">
      <div id="config-area">
        <div class="section">
          <div class="section-header">
            <div>
              <h2 class="section-title">My Teams</h2>
              <p class="section-subtitle">Save and manage multiple rosters</p>
            </div>
          </div>
          
          <div class="btn-group">
            <select id="savedTeams" class="btn btn-secondary btn-small" style="flex: 2;">
              <option value="">Select a saved team...</option>
            </select>
            <button class="btn btn-success btn-small" onclick="saveCurrentTeam()">üíæ Save</button>
            <button class="btn btn-error btn-small" onclick="deleteSelectedTeam()">üóëÔ∏è Delete</button>
          </div>
        </div>

        <div class="section">
          <div class="form-group">
            <label>League Format</label>
            <select id="format">
              <option>Standard (Non-PPR)</option>
              <option selected>PPR</option>
              <option>Half-PPR</option>
              <option>2QB</option>
              <option>Superflex</option>
              <option>Dynasty PPR</option>
              <option>Custom</option>
            </select>
            <div id="custom-format-wrapper">
              <input id="custom-format" placeholder="e.g. TE Premium, 3 FLEX, IDP">
            </div>
          </div>

          <div class="form-group">
            <label>Additional Notes</label>
            <textarea id="notes" rows="2" placeholder="Weather concerns, injury updates, tough matchups..."></textarea>
          </div>
        </div>

        <!-- Weather Conditions Section -->
        <div id="weather-section" class="section" style="display: none;">
          <div class="weather-conditions">
            <div class="weather-title">
              üå¶Ô∏è Weather Alerts
            </div>
            <div id="weather-games" class="weather-games">
              <!-- Weather alerts will be populated here -->
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <div>
              <h2 class="section-title">Build Your Roster</h2>
              <p class="section-subtitle">Add your players by position</p>
            </div>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-secondary btn-small" onclick="randomizeRoster()">üé≤ Random Roster</button>
            <button class="btn btn-secondary btn-small" onclick="clearRoster()">üßπ Clear All</button>
          </div>
          
          <div id="roster-builder">
            <!-- Roster positions will be dynamically generated here -->
          </div>
        </div>

        <button class="btn btn-primary" style="width: 100%;" onclick="getAdvice()">
          üéØ Get Lineup Advice
        </button>
      </div>

      <div id="output" class="output-card" style="display: none;">
        <!-- Advice will appear here -->
      </div>

      <div id="rebuttal" class="output-card" style="display: none;">
        <!-- Coach rebuttal will appear here -->
      </div>
    </div>

    <button id="back-btn" class="btn btn-secondary back-btn" style="display: none;" onclick="toggleConfig()">
      ‚Üê
    </button>
  </div>

  <script>
    // Dark mode functionality
    function toggleTheme() {
      const body = document.body;
      const button = document.querySelector('.theme-toggle');
      
      if (body.getAttribute('data-theme') === 'dark') {
        body.removeAttribute('data-theme');
        button.textContent = 'üåô';
        localStorage.setItem('theme', 'light');
      } else {
        body.setAttribute('data-theme', 'dark');
        button.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'dark');
      }
    }

    // Load saved theme on page load
    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('theme');
      const button = document.querySelector('.theme-toggle');
      
      if (savedTheme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        button.textContent = '‚òÄÔ∏è';
      } else {
        button.textContent = 'üåô';
      }
    }

    // Mock injury data (in production, this would come from an API)
    const injuryData = {
      'Christian McCaffrey': { status: 'questionable', injury: 'Achilles' },
      'Tyreek Hill': { status: 'healthy' },
      'Nick Chubb': { status: 'out', injury: 'Knee' },
      'Cooper Kupp': { status: 'doubtful', injury: 'Ankle' },
      'Travis Kelce': { status: 'healthy' },
      'Ja\'Marr Chase': { status: 'questionable', injury: 'Hip' },
      'Saquon Barkley': { status: 'healthy' },
      'Josh Allen': { status: 'healthy' }
    };

    // Mock weather data (in production, this would come from a weather API)
    const weatherData = [
      { game: 'BUF @ DEN', conditions: 'Snow, 20mph winds', severity: 'bad' },
      { game: 'GB @ CHI', conditions: 'Rain, 15mph winds', severity: 'moderate' },
      { game: 'MIA @ NE', conditions: 'Cold, 25¬∞F', severity: 'moderate' }
    ];

    // Mock defense vs position rankings (in production, this would come from an API)
    const defenseRankings = {
      'ARI': { vs_QB: 32, vs_RB: 15, vs_WR: 28, vs_TE: 20 },
      'ATL': { vs_QB: 25, vs_RB: 8, vs_WR: 22, vs_TE: 12 },
      'BAL': { vs_QB: 8, vs_RB: 5, vs_WR: 10, vs_TE: 3 },
      'BUF': { vs_QB: 12, vs_RB: 18, vs_WR: 6, vs_TE: 15 },
      'CAR': { vs_QB: 28, vs_RB: 22, vs_WR: 30, vs_TE: 25 },
      'CHI': { vs_QB: 10, vs_RB: 12, vs_WR: 8, vs_TE: 7 },
      'CIN': { vs_QB: 20, vs_RB: 28, vs_WR: 25, vs_TE: 30 },
      'CLE': { vs_QB: 15, vs_RB: 10, vs_WR: 12, vs_TE: 8 },
      'DAL': { vs_QB: 18, vs_RB: 25, vs_WR: 20, vs_TE: 22 },
      'DEN': { vs_QB: 5, vs_RB: 8, vs_WR: 4, vs_TE: 2 },
      'DET': { vs_QB: 30, vs_RB: 32, vs_WR: 32, vs_TE: 32 },
      'GB': { vs_QB: 22, vs_RB: 20, vs_WR: 18, vs_TE: 18 },
      'HOU': { vs_QB: 14, vs_RB: 15, vs_WR: 14, vs_TE: 10 },
      'IND': { vs_QB: 24, vs_RB: 30, vs_WR: 28, vs_TE: 28 },
      'JAX': { vs_QB: 26, vs_RB: 24, vs_WR: 26, vs_TE: 24 },
      'KC': { vs_QB: 6, vs_RB: 6, vs_WR: 5, vs_TE: 4 },
      'LV': { vs_QB: 29, vs_RB: 26, vs_WR: 24, vs_TE: 26 },
      'LAC': { vs_QB: 11, vs_RB: 14, vs_WR: 11, vs_TE: 9 },
      'LAR': { vs_QB: 16, vs_RB: 16, vs_WR: 15, vs_TE: 14 },
      'MIA': { vs_QB: 9, vs_RB: 7, vs_WR: 9, vs_TE: 6 },
      'MIN': { vs_QB: 13, vs_RB: 11, vs_WR: 13, vs_TE: 11 },
      'NE': { vs_QB: 17, vs_RB: 19, vs_WR: 16, vs_TE: 16 },
      'NO': { vs_QB: 19, vs_RB: 17, vs_WR: 19, vs_TE: 17 },
      'NYG': { vs_QB: 27, vs_RB: 29, vs_WR: 27, vs_TE: 29 },
      'NYJ': { vs_QB: 7, vs_RB: 4, vs_WR: 7, vs_TE: 5 },
      'PHI': { vs_QB: 21, vs_RB: 21, vs_WR: 21, vs_TE: 21 },
      'PIT': { vs_QB: 3, vs_RB: 2, vs_WR: 2, vs_TE: 1 },
      'SF': { vs_QB: 4, vs_RB: 3, vs_WR: 3, vs_TE: 3 },
      'SEA': { vs_QB: 23, vs_RB: 23, vs_WR: 23, vs_TE: 23 },
      'TB': { vs_QB: 31, vs_RB: 31, vs_WR: 31, vs_TE: 31 },
      'TEN': { vs_QB: 32, vs_RB: 27, vs_WR: 29, vs_TE: 27 },
      'WSH': { vs_QB: 1, vs_RB: 1, vs_WR: 1, vs_TE: 1 }
    };

    function getInjuryStatus(playerName) {
      return injuryData[playerName] || { status: 'healthy' };
    }

    function getInjuryDot(status) {
      const dotClass = status === 'healthy' ? 'healthy' : 
                     status === 'questionable' ? 'questionable' :
                     status === 'doubtful' ? 'doubtful' : 'out';
      return `<span class="injury-dot ${dotClass}"></span>`;
    }

    function getInjuryBadge(status, injury) {
      if (status === 'healthy') return '';
      
      const badge = status === 'questionable' ? 'Q' :
                   status === 'doubtful' ? 'D' :
                   status === 'out' ? 'O' : '';
      
      return badge ? `<span class="injury-badge">${badge}</span>` : '';
    }

    function getDefenseRank(team, position) {
      const positionKey = `vs_${position}`;
      const rank = defenseRankings[team]?.[positionKey] || 16;
      
      let rankClass = 'average';
      if (rank <= 10) rankClass = 'good';      // Top 10 = good matchup
      if (rank >= 23) rankClass = 'bad';       // Bottom 10 = bad matchup
      
      return { rank, class: rankClass };
    }

    function displayWeatherAlerts() {
      const weatherSection = document.getElementById('weather-section');
      const weatherGames = document.getElementById('weather-games');
      
      if (weatherData.length > 0) {
        weatherSection.style.display = 'block';
        weatherGames.innerHTML = weatherData.map(game => `
          <div class="weather-game ${game.severity}">
            <span><strong>${game.game}</strong></span>
            <span>${game.conditions}</span>
          </div>
        `).join('');
      } else {
        weatherSection.style.display = 'none';
      }
    }

    function getRecommendedWaiverPickups() {
      // Fallback waiver recommendations when backend doesn't provide them
      // In production, this could be based on recent breakouts, injuries, etc.
      const hotWaiverTargets = [
        'Tank Dell', 'Tyler Boyd', 'Roschon Johnson', 'Ty Chandler',
        'Demarcus Robinson', 'Noah Brown', 'Zay Jones', 'Deon Jackson',
        'Isaiah Likely', 'Tyler Conklin', 'Jordan Mason', 'Rico Dowdle'
      ];
      
      // Return 4-6 random recommendations
      const shuffled = hotWaiverTargets.sort(() => 0.5 - Math.random());
      return shuffled.slice(0, Math.floor(Math.random() * 3) + 4);
    }

    // Collapsible sections functionality
    function toggleSection(sectionId) {
      const toggle = document.querySelector(`[data-section="${sectionId}"]`);
      const content = document.getElementById(`${sectionId}-content`);
      
      if (!toggle || !content) return;
      
      const isExpanded = toggle.classList.contains('expanded');
      
      if (isExpanded) {
        toggle.classList.remove('expanded');
        toggle.classList.add('collapsed');
        content.classList.remove('expanded');
        content.classList.add('collapsed');
      } else {
        toggle.classList.remove('collapsed');
        toggle.classList.add('expanded');
        content.classList.remove('collapsed');
        content.classList.add('expanded');
      }
    }

    // Confidence score generation
    function getConfidenceScore(playerName, position) {
      // Mock confidence scores - in production this would come from your AI model
      const confidenceData = {
        'Josh Allen': 95,
        'Christian McCaffrey': 92,
        'Tyreek Hill': 88,
        'Travis Kelce': 85,
        'Justin Tucker': 82,
        'San Francisco 49ers': 78,
        'Saquon Barkley': 87,
        'Cooper Kupp': 75, // Lower due to injury concerns
        'Nick Chubb': 45,  // Very low due to injury
      };
      
      // Generate a base score if not in our data
      let score = confidenceData[playerName];
      if (!score) {
        // Generate realistic scores based on position
        const baseScores = {
          'QB': 75,
          'RB': 70,
          'WR': 68,
          'TE': 65,
          'DST': 60,
          'K': 55
        };
        score = baseScores[position] + Math.floor(Math.random() * 25) - 10;
        score = Math.max(40, Math.min(95, score)); // Keep between 40-95
      }
      
      return score;
    }

    function getConfidenceClass(score) {
      if (score >= 80) return 'high';
      if (score >= 65) return 'medium';
      return 'low';
    }

    function getConfidenceText(score) {
      if (score >= 80) return 'CONFIDENT';
      if (score >= 65) return 'SOLID';
      return 'RISKY';
    }

    // Player-specific challenge functionality
    function openPlayerChallenge(playerName, position) {
      const modal = document.getElementById('player-challenge-modal');
      const playerNameEl = document.getElementById('challenge-player-name');
      const suggestionsEl = document.getElementById('challenge-suggestions');
      
      playerNameEl.textContent = playerName;
      
      // Generate position-specific challenge suggestions
      const suggestions = generateChallengeSuggestions(playerName, position);
      suggestionsEl.innerHTML = suggestions.map(suggestion => `
        <div class="challenge-suggestion" onclick="sendPlayerChallenge('${playerName}', '${suggestion}')">
          ${suggestion}
        </div>
      `).join('');
      
      modal.classList.add('show');
    }

    function closePlayerChallenge() {
      const modal = document.getElementById('player-challenge-modal');
      modal.classList.remove('show');
    }

    function generateChallengeSuggestions(playerName, position) {
      const suggestions = {
        'QB': [
          `Why start ${playerName} over other QB options?`,
          `Is ${playerName}'s matchup really that good?`,
          `What if ${playerName} has a bad game?`
        ],
        'RB': [
          `Why ${playerName} over other RBs on my roster?`,
          `Is ${playerName} getting enough touches lately?`,
          `What about ${playerName}'s injury concerns?`
        ],
        'WR': [
          `Why trust ${playerName} this week?`,
          `Is ${playerName} the best WR option I have?`,
          `What if ${playerName}'s target share drops?`
        ],
        'TE': [
          `Why ${playerName} at TE this week?`,
          `Is ${playerName} still the primary target?`,
          `What about other TE streaming options?`
        ],
        'DST': [
          `Why ${playerName} defense over others?`,
          `Is this matchup really favorable?`,
          `What about turnovers and sacks potential?`
        ],
        'K': [
          `Why ${playerName} over other kickers?`,
          `Is the weather going to affect kicks?`,
          `What about red zone opportunities?`
        ]
      };
      
      return suggestions[position] || [`Why start ${playerName}?`, `Is this the right choice?`, `What are the alternatives?`];
    }

    async function sendPlayerChallenge(playerName, challenge) {
      closePlayerChallenge();
      
      const rebuttalBox = document.getElementById("rebuttal");
      const format = document.getElementById("format").value;
      const custom = document.getElementById("custom-format").value;
      const fullFormat = format === "Custom" ? `Custom: ${custom}` : format;

      rebuttalBox.style.display = "block";
      rebuttalBox.className = "output-card loading fade-in";
      rebuttalBox.innerHTML = "Coach is preparing a response...";

      try {
        const res = await fetch("/challenge", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ 
            advice: {
              recommended_starters: {}, // We'll need to populate this properly
              bench: [], 
              waiver_watchlist: [], 
              strategy_summary: ""
            }, 
            scoring_format: fullFormat, 
            user_challenge: `${challenge} (Specifically about ${playerName})`
          })
        });
        const data = await res.json();
        
        rebuttalBox.className = "output-card fade-in";
        rebuttalBox.innerHTML = data.error
          ? `<div style="color: var(--error-red);">‚ö†Ô∏è ${data.error}</div>`
          : `<div class="challenge-card">
               <h3 class="challenge-title">üóØÔ∏è Coach's Response about ${playerName}</h3>
               <p style="margin: 0; line-height: 1.5; color: #92400E;">${data.rebuttal}</p>
             </div>`;
      } catch {
        rebuttalBox.className = "output-card";
        rebuttalBox.innerHTML = '<div style="color: var(--error-red);">‚ùå Coach failed to respond.</div>';
      }
    }

    // NFL Player Database (2025 Season - Updated with 2024 & 2025 Rookies)
    const playerDatabase = {
      QB: [
        // Established Veterans
        'Josh Allen', 'Lamar Jackson', 'Patrick Mahomes', 'Joe Burrow', 'Jalen Hurts',
        'Justin Herbert', 'Dak Prescott', 'Tua Tagovailoa', 'Kyler Murray', 'Russell Wilson',
        'Aaron Rodgers', 'Geno Smith', 'Kirk Cousins', 'Trevor Lawrence', 'Anthony Richardson',
        'Brock Purdy', 'Jared Goff', 'Daniel Jones', 'Derek Carr', 'Justin Fields',
        'C.J. Stroud', 'Kenny Pickett', 'Deshaun Watson', 'Ryan Tannehill', 'Mac Jones',
        'Bryce Young', 'Will Levis', 'Sam Howell', 'Baker Mayfield', 'Jordan Love',
        'Aidan O\'Connell', 'Tommy DeVito', 'Mason Rudolph', 'Gardner Minshew', 'Jacoby Brissett',
        
        // 2024 Rookies (Now Second Year)
        'Jayden Daniels', 'Caleb Williams', 'Drake Maye', 'Bo Nix', 'J.J. McCarthy', 'Michael Penix Jr.',
        
        // 2025 Rookies
        'Cam Ward', 'Dillon Gabriel', 'Shedeur Sanders', 'Jalen Milroe', 'Quinn Ewers',
        'Kyle McCord', 'Tyler Shough', 'Will Howard', 'Aidan Chiles', 'Thomas Castellanos'
      ],
      RB: [
        // Established Veterans
        'Christian McCaffrey', 'Austin Ekeler', 'Derrick Henry', 'Josh Jacobs', 'Nick Chubb',
        'Saquon Barkley', 'Tony Pollard', 'Aaron Jones', 'Joe Mixon', 'Kenneth Walker III',
        'Najee Harris', 'Alvin Kamara', 'Ezekiel Elliott', 'Miles Sanders', 'David Montgomery',
        'Rhamondre Stevenson', 'James Conner', 'Travis Etienne', 'D\'Andre Swift', 'Javonte Williams',
        'Alexander Mattison', 'Rachaad White', 'Jerome Ford', 'Isiah Pacheco', 'Breece Hall',
        'Jonathan Taylor', 'Cam Akers', 'Khalil Herbert', 'Zamir White', 'Tyler Allgeier',
        'James Cook', 'Brian Robinson Jr.', 'Gus Edwards', 'Chuba Hubbard', 'Roschon Johnson',
        'Antonio Gibson', 'Tank Bigsby', 'Jaylen Warren', 'Justice Hill', 'Rico Dowdle',
        'Dameon Pierce', 'Kenneth Gainwell', 'Devin Singletary', 'Elijah Mitchell', 'Jordan Mason',
        'Ty Chandler', 'AJ Dillon', 'Samaje Perine', 'Clyde Edwards-Helaire', 'Zack Moss',
        
        // 2024 Rookies (Now Second Year)
        'Jayden Reed', 'Blake Corum', 'Trey Benson', 'MarShawn Lloyd', 'Jaylen Wright',
        'Braelon Allen', 'Jonathon Brooks', 'Ray Davis', 'Kimani Vidal', 'Isaac Guerendo',
        
        // 2025 Rookies  
        'Ashton Jeanty', 'Omarion Hampton', 'Quinshon Judkins', 'Dylan Sampson', 'Cam Skattebo',
        'TreVeyon Henderson', 'Nicholas Singleton', 'Kaleb Johnson', 'RJ Harvey', 'Woody Marks'
      ],
      WR: [
        // Established Veterans
        'Tyreek Hill', 'Stefon Diggs', 'Davante Adams', 'Cooper Kupp', 'DeAndre Hopkins',
        'A.J. Brown', 'Mike Evans', 'Keenan Allen', 'Amari Cooper', 'Tyler Lockett',
        'DK Metcalf', 'CeeDee Lamb', 'Ja\'Marr Chase', 'Justin Jefferson', 'Amon-Ra St. Brown',
        'Puka Nacua', 'Chris Olave', 'Garrett Wilson', 'Jaylen Waddle', 'Terry McLaurin',
        'Calvin Ridley', 'DJ Moore', 'Michael Pittman Jr.', 'Courtland Sutton', 'Tee Higgins',
        'Mike Williams', 'Jerry Jeudy', 'Diontae Johnson', 'Christian Kirk', 'Marquise Goodwin',
        'Drake London', 'Chris Godwin', 'Brandon Aiyuk', 'Deebo Samuel', 'Rashod Bateman',
        'Elijah Moore', 'Gabe Davis', 'Curtis Samuel', 'Adam Thielen', 'Jordan Addison',
        'Tank Dell', 'Nico Collins', 'George Pickens', 'Christian Watson', 'Romeo Doubs',
        'DeVonta Smith', 'Zay Flowers', 'Rashee Rice', 'Josh Palmer', 'Tutu Atwell',
        'Darius Slayton', 'Noah Brown', 'Wan\'Dale Robinson', 'Isaiah Hodgins', 'Donovan Peoples-Jones',
        
        // 2024 Rookies (Now Second Year)
        'Malik Nabers', 'Jayden Reed', 'Rome Odunze', 'Marvin Harrison Jr.', 'Brian Thomas Jr.',
        'Xavier Worthy', 'Ladd McConkey', 'Keon Coleman', 'Xavier Legette', 'Adonai Mitchell',
        'Ricky Pearsall', 'Ja\'Lynn Polk', 'Luke McCaffrey', 'Jalen McMillan', 'Troy Franklin',
        
        // 2025 Rookies
        'Travis Hunter', 'Matthew Golden', 'Emeka Egbuka', 'Tetairoa McMillan', 'Luther Burden III',
        'Elic Ayomanor', 'Jaylin Noel', 'Jayden Higgins', 'Jalen Royals', 'Isaiah Bond',
        'Savion Williams', 'Jaylin Lane', 'Tai Felton', 'Jeshaun Jones', 'Kevin Concepcion'
      ],
      TE: [
        // Established Veterans
        'Travis Kelce', 'Mark Andrews', 'T.J. Hockenson', 'George Kittle', 'Darren Waller',
        'Kyle Pitts', 'Dallas Goedert', 'Evan Engram', 'Sam LaPorta', 'David Njoku',
        'Pat Freiermuth', 'Tyler Higbee', 'Gerald Everett', 'Cole Kmet', 'Dawson Knox',
        'Jake Ferguson', 'Noah Fant', 'Hayden Hurst', 'Logan Thomas', 'Hunter Henry',
        'Mike Gesicki', 'Isaiah Likely', 'Chigoziem Okonkwo', 'Luke Musgrave', 'Tucker Kraft',
        'Juwan Johnson', 'Durham Smythe', 'Will Dissly', 'Irv Smith Jr.', 'Tyler Conklin',
        'Trey McBride', 'Daniel Bellinger', 'Greg Dulcich', 'Cade Otton', 'Foster Moreau',
        
        // 2024 Rookies (Now Second Year)
        'Brock Bowers', 'Ja\'Tavion Sanders', 'Ben Sinnott', 'Theo Johnson', 'Erick All Jr.',
        'Dalton Kincaid', 'Michael Mayer',
        
        // 2025 Rookies
        'Tyler Warren', 'Colston Loveland', 'Harold Fannin Jr.', 'Mitchell Evans', 'Oscar Delp',
        'Gunnar Helm', 'Jake Briningstool', 'Eli Stowers', 'Nick Elksnis', 'Walker Lyons'
      ],
      DST: [
        // Team Defenses (2025 Season)
        'Arizona Cardinals', 'Atlanta Falcons', 'Baltimore Ravens', 'Buffalo Bills', 'Carolina Panthers',
        'Chicago Bears', 'Cincinnati Bengals', 'Cleveland Browns', 'Dallas Cowboys', 'Denver Broncos',
        'Detroit Lions', 'Green Bay Packers', 'Houston Texans', 'Indianapolis Colts', 'Jacksonville Jaguars',
        'Kansas City Chiefs', 'Las Vegas Raiders', 'Los Angeles Chargers', 'Los Angeles Rams', 'Miami Dolphins',
        'Minnesota Vikings', 'New England Patriots', 'New Orleans Saints', 'New York Giants', 'New York Jets',
        'Philadelphia Eagles', 'Pittsburgh Steelers', 'San Francisco 49ers', 'Seattle Seahawks', 'Tampa Bay Buccaneers',
        'Tennessee Titans', 'Washington Commanders'
      ],
      K: [
        // Kickers (2025 Season)
        'Justin Tucker', 'Harrison Butker', 'Tyler Bass', 'Younghoe Koo', 'Brandon McManus',
        'Daniel Carlson', 'Jake Moody', 'Cameron Dicker', 'Chris Boswell', 'Evan McPherson',
        'Ka\'imi Fairbairn', 'Matt Gay', 'Jason Sanders', 'Greg Zuerlein', 'Wil Lutz',
        'Mason Crosby', 'Matt Prater', 'Ryan Succop', 'Dustin Hopkins', 'Cairo Santos',
        'Nick Folk', 'Joey Slye', 'Graham Gano', 'Blake Grupe', 'Chad Ryland',
        'Anders Carlson', 'Jake Elliott', 'Cade York', 'Austin Seibert', 'Jason Myers',
        'Brandon McMannus', 'Riley Patterson'
      ]
    };

    // Player to Team Mapping (2025 Season)
    const playerTeams = {
      // QBs
      'Josh Allen': 'BUF', 'Lamar Jackson': 'BAL', 'Patrick Mahomes': 'KC', 'Joe Burrow': 'CIN', 'Jalen Hurts': 'PHI',
      'Justin Herbert': 'LAC', 'Dak Prescott': 'DAL', 'Tua Tagovailoa': 'MIA', 'Kyler Murray': 'ARI', 'Russell Wilson': 'PIT',
      'Aaron Rodgers': 'NYJ', 'Geno Smith': 'SEA', 'Kirk Cousins': 'ATL', 'Trevor Lawrence': 'JAX', 'Anthony Richardson': 'IND',
      'Brock Purdy': 'SF', 'Jared Goff': 'DET', 'Daniel Jones': 'NYG', 'Derek Carr': 'NO', 'Justin Fields': 'PIT',
      'C.J. Stroud': 'HOU', 'Kenny Pickett': 'PHI', 'Deshaun Watson': 'CLE', 'Ryan Tannehill': 'FA', 'Mac Jones': 'JAX',
      'Bryce Young': 'CAR', 'Will Levis': 'TEN', 'Sam Howell': 'SEA', 'Baker Mayfield': 'TB', 'Jordan Love': 'GB',
      'Aidan O\'Connell': 'LV', 'Tommy DeVito': 'NYG', 'Mason Rudolph': 'TEN', 'Gardner Minshew': 'LV', 'Jacoby Brissett': 'NE',
      'Jayden Daniels': 'WSH', 'Caleb Williams': 'CHI', 'Drake Maye': 'NE', 'Bo Nix': 'DEN', 'J.J. McCarthy': 'MIN', 'Michael Penix Jr.': 'ATL',
      'Cam Ward': 'TEN', 'Dillon Gabriel': 'CLE', 'Shedeur Sanders': 'CLE', 'Kyle McCord': 'PHI',

      // RBs  
      'Christian McCaffrey': 'SF', 'Austin Ekeler': 'WSH', 'Derrick Henry': 'BAL', 'Josh Jacobs': 'GB', 'Nick Chubb': 'CLE',
      'Saquon Barkley': 'PHI', 'Tony Pollard': 'TEN', 'Aaron Jones': 'MIN', 'Joe Mixon': 'HOU', 'Kenneth Walker III': 'SEA',
      'Najee Harris': 'PIT', 'Alvin Kamara': 'NO', 'James Conner': 'ARI', 'Travis Etienne': 'JAX', 'D\'Andre Swift': 'CHI',
      'Javonte Williams': 'DEN', 'Rachaad White': 'TB', 'Jerome Ford': 'CLE', 'Isiah Pacheco': 'KC', 'Breece Hall': 'NYJ',
      'Jonathan Taylor': 'IND', 'James Cook': 'BUF', 'Brian Robinson Jr.': 'WSH', 'Gus Edwards': 'LAC', 'Chuba Hubbard': 'CAR',
      'Roschon Johnson': 'CHI', 'Tank Bigsby': 'JAX', 'Jaylen Warren': 'PIT', 'Justice Hill': 'BAL', 'Rico Dowdle': 'DAL',
      'Kenneth Gainwell': 'PHI', 'Devin Singletary': 'NYG', 'Jordan Mason': 'SF', 'Ty Chandler': 'MIN', 'AJ Dillon': 'GB',
      'Zamir White': 'LV', 'Tyler Allgeier': 'ATL', 'Khalil Herbert': 'CHI', 'Zack Moss': 'CIN', 'Cam Akers': 'HOU',
      'Ashton Jeanty': 'LV', 'Omarion Hampton': 'LAC', 'Blake Corum': 'LAR', 'Trey Benson': 'ARI', 'Braelon Allen': 'NYJ',

      // WRs
      'Tyreek Hill': 'MIA', 'Stefon Diggs': 'HOU', 'Davante Adams': 'LV', 'Cooper Kupp': 'LAR', 'DeAndre Hopkins': 'KC',
      'A.J. Brown': 'PHI', 'Mike Evans': 'TB', 'Keenan Allen': 'CHI', 'Amari Cooper': 'BUF', 'Tyler Lockett': 'SEA',
      'DK Metcalf': 'SEA', 'CeeDee Lamb': 'DAL', 'Ja\'Marr Chase': 'CIN', 'Justin Jefferson': 'MIN', 'Amon-Ra St. Brown': 'DET',
      'Puka Nacua': 'LAR', 'Chris Olave': 'NO', 'Garrett Wilson': 'NYJ', 'Jaylen Waddle': 'MIA', 'Terry McLaurin': 'WSH',
      'Calvin Ridley': 'TEN', 'DJ Moore': 'CHI', 'Michael Pittman Jr.': 'IND', 'Courtland Sutton': 'DEN', 'Tee Higgins': 'CIN',
      'Jerry Jeudy': 'CLE', 'Drake London': 'ATL', 'Chris Godwin': 'TB', 'Deebo Samuel': 'WSH', 'DeVonta Smith': 'PHI',
      'Zay Flowers': 'BAL', 'George Pickens': 'PIT', 'Tank Dell': 'HOU', 'Nico Collins': 'HOU', 'Christian Watson': 'GB',
      'Romeo Doubs': 'GB', 'Jordan Addison': 'MIN', 'Rashee Rice': 'KC', 'Josh Palmer': 'LAC', 'Marquise Goodwin': 'KC',
      'Malik Nabers': 'NYG', 'Rome Odunze': 'CHI', 'Marvin Harrison Jr.': 'ARI', 'Brian Thomas Jr.': 'JAX', 'Xavier Worthy': 'KC',
      'Ladd McConkey': 'LAC', 'Keon Coleman': 'BUF', 'Xavier Legette': 'CAR', 'Ricky Pearsall': 'SF', 'Ja\'Lynn Polk': 'NE',
      'Travis Hunter': 'COL', 'Emeka Egbuka': 'TB', 'Matthew Golden': 'HOU',

      // TEs
      'Travis Kelce': 'KC', 'Mark Andrews': 'BAL', 'T.J. Hockenson': 'MIN', 'George Kittle': 'SF', 'Kyle Pitts': 'ATL',
      'Dallas Goedert': 'PHI', 'Evan Engram': 'JAX', 'Sam LaPorta': 'DET', 'David Njoku': 'CLE', 'Pat Freiermuth': 'PIT',
      'Jake Ferguson': 'DAL', 'Dawson Knox': 'BUF', 'Cole Kmet': 'CHI', 'Trey McBride': 'ARI', 'Tyler Higbee': 'LAR',
      'Gerald Everett': 'CHI', 'Noah Fant': 'SEA', 'Hunter Henry': 'NE', 'Mike Gesicki': 'CIN', 'Isaiah Likely': 'BAL',
      'Luke Musgrave': 'GB', 'Tucker Kraft': 'GB', 'Will Dissly': 'LAC', 'Tyler Conklin': 'NYJ', 'Cade Otton': 'TB',
      'Brock Bowers': 'LV', 'Dalton Kincaid': 'BUF', 'Michael Mayer': 'LV', 'Tyler Warren': 'PIT', 'Colston Loveland': 'DET'
    };

    // Roster management
    let roster = {
      QB: [],
      RB: [],
      WR: [],
      TE: [],
      FLEX: [],
      DST: [],
      K: [],
      BENCH: []
    };

    const positionLimits = {
      QB: 3,
      RB: 6,
      WR: 6,
      TE: 3,
      FLEX: 2,
      DST: 2,
      K: 2,
      BENCH: 8
    };

    // League Format Position Limits
    const formatLimits = {
      'Standard (Non-PPR)': {
        QB: 2,
        RB: 4,
        WR: 5,
        TE: 2,
        FLEX: 1,
        DST: 2,
        K: 2,
        BENCH: 6
      },
      'PPR': {
        QB: 2,
        RB: 5,
        WR: 6,
        TE: 2,
        FLEX: 2,
        DST: 2,
        K: 2,
        BENCH: 7
      },
      'Half-PPR': {
        QB: 2,
        RB: 5,
        WR: 6,
        TE: 2,
        FLEX: 2,
        DST: 2,
        K: 2,
        BENCH: 7
      },
      '2QB': {
        QB: 3,
        RB: 4,
        WR: 5,
        TE: 2,
        FLEX: 2,
        DST: 2,
        K: 2,
        BENCH: 8
      },
      'Superflex': {
        QB: 3,
        RB: 5,
        WR: 6,
        TE: 2,
        FLEX: 2,
        DST: 2,
        K: 2,
        BENCH: 8
      },
      'Dynasty PPR': {
        QB: 3,
        RB: 8,
        WR: 10,
        TE: 3,
        FLEX: 3,
        DST: 3,
        K: 3,
        BENCH: 15
      },
      'Custom': {
        QB: 3,
        RB: 6,
        WR: 6,
        TE: 3,
        FLEX: 2,
        DST: 2,
        K: 2,
        BENCH: 8
      }
    };

    // Team Management with localStorage
    function getSavedTeams() {
      try {
        return JSON.parse(localStorage.getItem('fantasyGPTTeams') || '{}');
      } catch (e) {
        console.error('Error loading saved teams:', e);
        return {};
      }
    }

    function saveTeamsToStorage(teams) {
      try {
        localStorage.setItem('fantasyGPTTeams', JSON.stringify(teams));
      } catch (e) {
        console.error('Error saving teams:', e);
        alert('Failed to save team. Storage may be full.');
      }
    }

    function updateSavedTeamsDropdown() {
      const dropdown = document.getElementById('savedTeams');
      const savedTeams = getSavedTeams();
      
      // Clear existing options except the first one
      dropdown.innerHTML = '<option value="">Select a saved team...</option>';
      
      // Add saved teams
      Object.keys(savedTeams).forEach(teamName => {
        const option = document.createElement('option');
        option.value = teamName;
        option.textContent = teamName;
        dropdown.appendChild(option);
      });
    }

    function saveCurrentTeam() {
      // Check if roster has any players
      const hasPlayers = Object.values(roster).some(position => 
        position.some(player => player && player.trim() !== '')
      );
      
      if (!hasPlayers) {
        alert('‚ö†Ô∏è Please add some players before saving!');
        return;
      }

      const teamName = prompt('Enter a name for this team:');
      if (!teamName || !teamName.trim()) {
        return;
      }

      const cleanedTeamName = teamName.trim();
      const savedTeams = getSavedTeams();
      
      // Check if team name already exists
      if (savedTeams[cleanedTeamName]) {
        if (!confirm(`Team "${cleanedTeamName}" already exists. Overwrite?`)) {
          return;
        }
      }

      // Save current roster and format
      const currentFormat = document.getElementById('format').value;
      const customFormat = document.getElementById('custom-format').value;
      
      savedTeams[cleanedTeamName] = {
        roster: JSON.parse(JSON.stringify(roster)),
        format: currentFormat,
        customFormat: customFormat,
        savedAt: new Date().toISOString()
      };

      saveTeamsToStorage(savedTeams);
      updateSavedTeamsDropdown();
      
      // Select the newly saved team
      document.getElementById('savedTeams').value = cleanedTeamName;
      
      alert(`‚úÖ Team "${cleanedTeamName}" saved successfully!`);
    }

    function loadSelectedTeam() {
      const dropdown = document.getElementById('savedTeams');
      const teamName = dropdown.value;
      
      if (!teamName) return;

      const savedTeams = getSavedTeams();
      const teamData = savedTeams[teamName];
      
      if (!teamData) {
        alert('‚ö†Ô∏è Team not found!');
        updateSavedTeamsDropdown();
        return;
      }

      try {
        // Load roster
        roster = JSON.parse(JSON.stringify(teamData.roster));
        
        // Load format
        document.getElementById('format').value = teamData.format || 'PPR';
        if (teamData.customFormat) {
          document.getElementById('custom-format').value = teamData.customFormat;
        }
        
        // Update position limits and render
        updatePositionLimits();
        renderRosterBuilder();
        
        // Brief visual feedback
        const dropdown = document.getElementById('savedTeams');
        const originalBg = dropdown.style.backgroundColor;
        dropdown.style.backgroundColor = 'var(--success-green)';
        dropdown.style.color = 'white';
        setTimeout(() => {
          dropdown.style.backgroundColor = originalBg;
          dropdown.style.color = '';
        }, 1000);
        
      } catch (e) {
        console.error('Error loading team:', e);
        alert('‚ö†Ô∏è Error loading team data!');
      }
    }

    function deleteSelectedTeam() {
      const dropdown = document.getElementById('savedTeams');
      const teamName = dropdown.value;
      
      if (!teamName) {
        alert('‚ö†Ô∏è Please select a team to delete.');
        return;
      }

      if (!confirm(`Are you sure you want to delete "${teamName}"?`)) {
        return;
      }

      const savedTeams = getSavedTeams();
      delete savedTeams[teamName];
      
      saveTeamsToStorage(savedTeams);
      updateSavedTeamsDropdown();
      
      alert(`üóëÔ∏è Team "${teamName}" deleted.`);
    }

    // Current position limits (will be updated based on format)
    let currentPositionLimits = { ...positionLimits };

    const sampleRosters = {
      ppr: {
        QB: ['Josh Allen'],
        RB: ['Christian McCaffrey', 'Saquon Barkley'],
        WR: ['Tyreek Hill', 'Stefon Diggs', 'Mike Evans'],
        TE: ['Travis Kelce'],
        FLEX: ['Tony Pollard'],
        DST: ['San Francisco 49ers'],
        K: ['Justin Tucker'],
        BENCH: ['Tua Tagovailoa', 'James Conner', 'Jerry Jeudy']
      },
      '2qb': {
        QB: ['Josh Allen', 'Lamar Jackson'],
        RB: ['Austin Ekeler', 'Josh Jacobs'],
        WR: ['Cooper Kupp', 'Davante Adams'],
        TE: ['Mark Andrews'],
        FLEX: ['Amari Cooper'],
        DST: ['Buffalo Bills'],
        K: ['Harrison Butker'],
        BENCH: ['Geno Smith', 'Rhamondre Stevenson']
      }
    };

    // Autocomplete functionality
    function createDropdown() {
      const dropdown = document.createElement('div');
      dropdown.className = 'autocomplete-dropdown';
      return dropdown;
    }

    function getRelevantPlayers(position, query) {
      // For FLEX, include RB, WR, TE (but not D/ST or K)
      // For BENCH, include all skill positions
      let availablePlayers = [];
      
      if (position === 'FLEX') {
        availablePlayers = [
          ...playerDatabase.RB,
          ...playerDatabase.WR, 
          ...playerDatabase.TE
        ];
      } else if (position === 'BENCH') {
        availablePlayers = [
          ...playerDatabase.QB,
          ...playerDatabase.RB,
          ...playerDatabase.WR, 
          ...playerDatabase.TE,
          ...playerDatabase.DST,
          ...playerDatabase.K
        ];
      } else if (playerDatabase[position]) {
        availablePlayers = playerDatabase[position];
      } else {
        // Fallback for any position
        availablePlayers = Object.values(playerDatabase).flat();
      }

      // Filter by query
      if (!query || query.length < 1) return [];
      
      const filtered = availablePlayers.filter(player => 
        player.toLowerCase().includes(query.toLowerCase())
      );
      
      // Sort by relevance (starts with query first, then contains)
      filtered.sort((a, b) => {
        const aStarts = a.toLowerCase().startsWith(query.toLowerCase());
        const bStarts = b.toLowerCase().startsWith(query.toLowerCase());
        if (aStarts && !bStarts) return -1;
        if (!aStarts && bStarts) return 1;
        return a.localeCompare(b);
      });
      
      return filtered.slice(0, 8); // Limit results
    }

    function getPlayerPosition(playerName) {
      for (const [position, players] of Object.entries(playerDatabase)) {
        if (players.includes(playerName)) {
          return position === 'DST' ? 'D/ST' : position; // Display D/ST instead of DST
        }
      }
      return '';
    }

    function getPlayerTeam(playerName) {
      return playerTeams[playerName] || '';
    }

    function setupAutocomplete(input, position, index) {
      const dropdown = input.parentNode.querySelector('.autocomplete-dropdown');
      let highlightedIndex = -1;
      let currentResults = [];

      function showDropdown(results) {
        currentResults = results;
        dropdown.innerHTML = '';
        
        if (results.length === 0) {
          const noResults = document.createElement('div');
          noResults.className = 'autocomplete-no-results';
          noResults.textContent = 'No players found';
          dropdown.appendChild(noResults);
        } else {
          results.forEach((player, idx) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            if (idx === highlightedIndex) {
              item.classList.add('highlighted');
            }
            
            const playerPos = getPlayerPosition(player);
            const playerTeam = getPlayerTeam(player);
            const injury = getInjuryStatus(player);
            
            item.innerHTML = `
              <span class="player-name">
                ${getInjuryDot(injury.status)}
                ${player}
                ${getInjuryBadge(injury.status, injury.injury)}
              </span>
              <div style="display: flex; gap: 6px; align-items: center;">
                <span class="player-position">${playerPos}</span>
                ${playerTeam ? `<span class="player-position" style="background: var(--primary-blue); color: white;">${playerTeam}</span>` : ''}
              </div>
            `;
            
            item.onclick = () => selectPlayer(player);
            dropdown.appendChild(item);
          });
        }
        
        dropdown.classList.add('show');
      }

      function hideDropdown() {
        dropdown.classList.remove('show');
        highlightedIndex = -1;
      }

      function selectPlayer(playerName) {
        input.value = playerName;
        updatePlayer(position, index, playerName);
        hideDropdown();
        input.blur();
      }

      function updateHighlight() {
        const items = dropdown.querySelectorAll('.autocomplete-item:not(.autocomplete-no-results)');
        items.forEach((item, idx) => {
          item.classList.toggle('highlighted', idx === highlightedIndex);
        });
      }

      // Input event handler
      input.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        updatePlayer(position, index, query);
        
        if (query.length >= 1) {
          const results = getRelevantPlayers(position, query);
          showDropdown(results);
          highlightedIndex = -1;
        } else {
          hideDropdown();
        }
      });

      // Keyboard navigation
      input.addEventListener('keydown', (e) => {
        const items = dropdown.querySelectorAll('.autocomplete-item:not(.autocomplete-no-results)');
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
            updateHighlight();
            break;
          case 'ArrowUp':
            e.preventDefault();
            highlightedIndex = Math.max(highlightedIndex - 1, -1);
            updateHighlight();
            break;
          case 'Enter':
            e.preventDefault();
            if (highlightedIndex >= 0 && currentResults[highlightedIndex]) {
              selectPlayer(currentResults[highlightedIndex]);
            }
            break;
          case 'Escape':
            hideDropdown();
            input.blur();
            break;
        }
      });

      // Focus/blur events
      input.addEventListener('focus', () => {
        const query = input.value.trim();
        if (query.length >= 1) {
          const results = getRelevantPlayers(position, query);
          showDropdown(results);
        }
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!input.parentNode.contains(e.target)) {
          hideDropdown();
        }
      });
    }

    function updatePositionLimits() {
      const format = document.getElementById("format").value;
      const customWrapper = document.getElementById("custom-format-wrapper");
      
      if (format === "Custom") {
        customWrapper.classList.add("show");
        // Keep current limits for custom
      } else {
        customWrapper.classList.remove("show");
        // Update limits based on format
        currentPositionLimits = { ...formatLimits[format] };
        
        // Trim rosters if they exceed new limits
        Object.keys(currentPositionLimits).forEach(position => {
          if (roster[position].length > currentPositionLimits[position]) {
            roster[position] = roster[position].slice(0, currentPositionLimits[position]);
          }
        });
        
        renderRosterBuilder();
      }
    }

    function renderRosterBuilder() {
      const container = document.getElementById('roster-builder');
      container.innerHTML = '';

      Object.keys(currentPositionLimits).forEach(position => {
        const positionCard = document.createElement('div');
        positionCard.className = 'position-card';
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'position-header';
        
        // Display D/ST instead of DST
        const displayPosition = position === 'DST' ? 'D/ST' : position;
        headerDiv.innerHTML = `
          <span class="position-title">${displayPosition}</span>
          <span class="position-count">${roster[position].length}/${currentPositionLimits[position]}</span>
        `;
        positionCard.appendChild(headerDiv);

        // Add existing players
        roster[position].forEach((player, index) => {
          const playerRow = document.createElement('div');
          playerRow.className = 'player-row';
          
          const autocompleteContainer = document.createElement('div');
          autocompleteContainer.className = 'autocomplete-container';
          
          const input = document.createElement('input');
          input.type = 'text';
          input.value = player;
          input.placeholder = 'Enter player name';
          input.setAttribute('data-position', position);
          input.setAttribute('data-index', index);
          
          autocompleteContainer.appendChild(input);
          autocompleteContainer.appendChild(createDropdown());
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn-error btn-small';
          removeBtn.textContent = '√ó';
          removeBtn.onclick = () => removePlayer(position, index);
          
          playerRow.appendChild(autocompleteContainer);
          playerRow.appendChild(removeBtn);
          positionCard.appendChild(playerRow);
          
          // Setup autocomplete for this input
          setupAutocomplete(input, position, index);
        });

        // Add button to add more players
        if (roster[position].length < currentPositionLimits[position]) {
          const addButton = document.createElement('button');
          addButton.className = 'btn add-player-btn';
          addButton.textContent = `+ Add ${displayPosition}`;
          addButton.onclick = () => addPlayer(position);
          positionCard.appendChild(addButton);
        }

        container.appendChild(positionCard);
      });
    }

    function addPlayer(position) {
      if (roster[position].length < currentPositionLimits[position]) {
        roster[position].push('');
        renderRosterBuilder();
        // Focus on the new input with a slight delay
        setTimeout(() => {
          const allInputs = document.querySelectorAll(`input[data-position="${position}"]`);
          const lastInput = allInputs[allInputs.length - 1];
          if (lastInput) {
            lastInput.focus();
          }
        }, 100);
      }
    }

    function removePlayer(position, index) {
      roster[position].splice(index, 1);
      renderRosterBuilder();
    }

    function updatePlayer(position, index, value) {
      roster[position][index] = value;
    }

    function randomizeRoster() {
      // Clear current roster
      Object.keys(currentPositionLimits).forEach(pos => {
        roster[pos] = [];
      });

      const usedPlayers = new Set();

      // Fill each position with random players
      Object.keys(currentPositionLimits).forEach(position => {
        const limit = currentPositionLimits[position];
        
        for (let i = 0; i < limit; i++) {
          let availablePlayers = [];
          
          // Get available players for this position
          if (position === 'FLEX') {
            // FLEX can use RB, WR, TE
            availablePlayers = [
              ...playerDatabase.RB,
              ...playerDatabase.WR,
              ...playerDatabase.TE
            ];
          } else if (position === 'BENCH') {
            // BENCH can use all positions
            availablePlayers = [
              ...playerDatabase.QB,
              ...playerDatabase.RB,
              ...playerDatabase.WR,
              ...playerDatabase.TE,
              ...playerDatabase.DST,
              ...playerDatabase.K
            ];
          } else if (playerDatabase[position]) {
            availablePlayers = [...playerDatabase[position]];
          }
          
          // Filter out already used players
          availablePlayers = availablePlayers.filter(player => !usedPlayers.has(player));
          
          // If we have available players, pick one randomly
          if (availablePlayers.length > 0) {
            const randomIndex = Math.floor(Math.random() * availablePlayers.length);
            const selectedPlayer = availablePlayers[randomIndex];
            roster[position].push(selectedPlayer);
            usedPlayers.add(selectedPlayer);
          }
        }
      });

      renderRosterBuilder();
    }

    function clearRoster() {
      Object.keys(currentPositionLimits).forEach(pos => {
        roster[pos] = [];
      });
      renderRosterBuilder();
    }

    function buildRosterJSON() {
      // Filter out empty player names and empty position arrays
      const cleanRoster = {};
      Object.keys(roster).forEach(pos => {
        const players = roster[pos].filter(p => p && p.trim() !== '');
        if (players.length > 0) {
          cleanRoster[pos] = players;
        }
      });
      return cleanRoster;
    }

    async function getAdvice() {
      const rosterData = buildRosterJSON();
      
      // Check if roster has any players
      if (Object.keys(rosterData).length === 0) {
        alert("‚ö†Ô∏è Please add some players to your roster first!");
        return;
      }

      document.getElementById("config-area").style.display = "none";
      document.getElementById("back-btn").style.display = "block";
      
      const outputDiv = document.getElementById("output");
      outputDiv.style.display = "block";
      outputDiv.className = "output-card loading fade-in";
      outputDiv.innerHTML = "Analyzing your roster and matchups...";

      const format = document.getElementById("format").value;
      const custom = document.getElementById("custom-format").value;
      const fullFormat = format === "Custom" ? `Custom: ${custom}` : format;
      const notes = document.getElementById("notes").value;

      try {
        const res = await fetch("/recommend", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ 
            scoring_format: fullFormat, 
            notes, 
            roster: rosterData 
          })
        });
        
        const data = await res.json();

        if (data.error) {
          outputDiv.className = "output-card";
          outputDiv.innerHTML = `<div style="color: var(--error-red);">‚ö†Ô∏è ${data.error}</div>`;
          return;
        }

        // Build the new compact lineup display with enhanced features
        let html = '<div class="lineup-container">';
        
        // Strategy Section - FIRST (Always expanded)
        html += `
          <div class="strategy-card">
            <h3 class="strategy-title">üß† AI Strategy Recommendation</h3>
            <p class="strategy-text">${data.strategy_summary}</p>
          </div>
        `;

        // Starting Lineup - SECOND (Always expanded with confidence scores)
        html += '<div class="starters-grid">';
        
        // Define the position order to match the roster builder
        const positionOrder = ['QB', 'RB', 'WR', 'TE', 'FLEX', 'DST', 'K'];
        
        positionOrder.forEach(pos => {
          if (data.recommended_starters[pos] && data.recommended_starters[pos].length > 0) {
            const players = data.recommended_starters[pos];
            // Display D/ST instead of DST
            const displayPos = pos === 'DST' ? 'D/ST' : pos;
            html += `
              <div class="position-group-display">
                <div class="position-group-header">${displayPos}</div>
                <div class="position-players">
                  ${players.map(p => {
                    const injury = getInjuryStatus(p);
                    const team = getPlayerTeam(p);
                    const playerPos = getPlayerPosition(p);
                    const defenseRank = team ? getDefenseRank(team, playerPos) : null;
                    const confidence = getConfidenceScore(p, pos);
                    const confidenceClass = getConfidenceClass(confidence);
                    const confidenceText = getConfidenceText(confidence);
                    
                    return `
                      <div class="starter-pill clickable" onclick="openPlayerChallenge('${p}', '${pos}')">
                        ${getInjuryDot(injury.status)}
                        ${p}
                        ${getInjuryBadge(injury.status, injury.injury)}
                        <span class="confidence-score ${confidenceClass}">${confidence}%</span>
                        ${defenseRank ? `<span class="defense-rank ${defenseRank.class}" title="Defense vs ${playerPos} rank">${defenseRank.rank}</span>` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          }
        });
        // Add help text for new interaction model
        html += `
          <div class="strategy-card" style="background: linear-gradient(135deg, #F0F9FF, #E0F2FE); border-color: #BAE6FD; margin-top: 16px;">
            <h3 style="color: var(--primary-blue); margin: 0 0 8px 0; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
              üí° Pro Tip
            </h3>
            <p style="margin: 0; line-height: 1.5; color: var(--text-secondary); font-size: 14px;">
              <strong>Click on any player above</strong> to challenge the coach's decision about them. 
              Expand sections below for bench players and waiver wire targets.
            </p>
          </div>
        `;

        html += '</div>';

        // Defense Matchup Guide - THIRD (Collapsible, collapsed by default)
        html += `
          <div class="section-collapsible">
            <div class="section-toggle collapsed" data-section="defense-guide" onclick="toggleSection('defense-guide')">
              <span class="section-toggle-title">üõ°Ô∏è Defense Matchup Guide</span>
              <span class="section-toggle-icon">‚ñº</span>
            </div>
            <div id="defense-guide-content" class="section-content collapsed">
              <div class="section-content-inner">
                <div style="font-size: 14px; color: var(--text-tertiary); line-height: 1.5;">
                  <div style="margin-bottom: 8px;">
                    <span class="defense-rank good">1-10</span> Easy matchup - Defense allows lots of points to this position
                  </div>
                  <div style="margin-bottom: 8px;">
                    <span class="defense-rank average">11-22</span> Average matchup - Neutral fantasy points allowed
                  </div>
                  <div>
                    <span class="defense-rank bad">23-32</span> Tough matchup - Defense is stingy against this position
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        // Bench Section - FOURTH (Collapsible, collapsed by default)
        if (data.bench && data.bench.length > 0) {
          html += `
            <div class="section-collapsible">
              <div class="section-toggle collapsed" data-section="bench" onclick="toggleSection('bench')">
                <span class="section-toggle-title">ü™ë Bench Players</span>
                <span class="section-toggle-icon">‚ñº</span>
              </div>
              <div id="bench-content" class="section-content collapsed">
                <div class="section-content-inner">
                  <div class="player-grid">
                    ${data.bench.map(p => {
                      const injury = getInjuryStatus(p);
                      return `
                        <div class="player-card">
                          <div class="player-name">
                            ${getInjuryDot(injury.status)}
                            ${p}
                            ${getInjuryBadge(injury.status, injury.injury)}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        // Waiver Watch Section - FIFTH (Collapsible, collapsed by default)
        const waiverPlayers = data.waiver_watchlist && data.waiver_watchlist.length > 0 
          ? data.waiver_watchlist 
          : getRecommendedWaiverPickups();
        
        html += `
          <div class="section-collapsible">
            <div class="section-toggle collapsed" data-section="waiver" onclick="toggleSection('waiver')">
              <span class="section-toggle-title">üìà Waiver Watch</span>
              <span class="section-toggle-icon">‚ñº</span>
            </div>
            <div id="waiver-content" class="section-content collapsed">
              <div class="section-content-inner">
                <div class="player-grid">
                  ${waiverPlayers.map(p => `
                    <div class="player-card">
                      <div class="player-name">${p}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;

        html += '</div>';

        // Add the player challenge modal
        html += `
          <div id="player-challenge-modal" class="player-challenge-modal" onclick="closePlayerChallenge()">
            <div class="player-challenge-content" onclick="event.stopPropagation()">
              <div class="player-challenge-header">
                <h3 class="player-challenge-title">Challenge About <span id="challenge-player-name"></span></h3>
                <button class="player-challenge-close" onclick="closePlayerChallenge()">√ó</button>
              </div>
              <div id="challenge-suggestions" class="challenge-suggestions">
                <!-- Challenge suggestions will be populated here -->
              </div>
              <div style="font-size: 12px; color: var(--text-tertiary); text-align: center;">
                Click a question above to challenge the coach's decision
              </div>
            </div>
          </div>
        `;

        outputDiv.className = "output-card fade-in";
        outputDiv.innerHTML = html;
        
      } catch (error) {
        outputDiv.className = "output-card";
        outputDiv.innerHTML = '<div style="color: var(--error-red);">‚ùå Failed to get advice. Please try again.</div>';
        console.error('Error:', error);
      }
    }

    function toggleConfig() {
      document.getElementById("config-area").style.display = "block";
      document.getElementById("back-btn").style.display = "none";
      document.getElementById("rebuttal").style.display = "none";
      document.getElementById("output").style.display = "none";
      closePlayerChallenge(); // Close any open challenge modal
    }

    async function challengeCoach() {
      // Legacy function - now replaced by player-specific challenges
      // Keep for backwards compatibility but redirect to general advice
      alert("üí° Try clicking on individual players in your starting lineup to challenge specific decisions!");
    }

    // Initialize everything on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Load saved theme
      loadSavedTheme();
      
      // Setup event listeners
      document.getElementById("format").addEventListener("change", updatePositionLimits);
      const dropdown = document.getElementById('savedTeams');
      if (dropdown) {
        dropdown.addEventListener('change', loadSelectedTeam);
      }
      
      // Add keyboard support for modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closePlayerChallenge();
        }
      });
      
      // Initialize roster and data
      updatePositionLimits(); // Set correct limits for default format
      updateSavedTeamsDropdown(); // Load saved teams
      renderRosterBuilder();
      displayWeatherAlerts(); // Show weather conditions
    });
  </script>
</div>
</body>
</html>